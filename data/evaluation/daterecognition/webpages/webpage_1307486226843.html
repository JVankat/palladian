<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>  Maggot Brain</title>
<meta name="generator" content="WordPress 3.1.3" /> <!-- leave this for stats -->
<meta name="keywords" content=" " /> <!-- enter a string of keywords that relate to your website inside the " " -->
<meta name="author" content=" " /><!-- enter your name inside the " "  -->
<meta name="description" content=" " /> <!-- enter site description inside the " "  -->
<link rel="stylesheet" href="http://blog.mozilla.com/axel/wp-content/themes/gathering/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Maggot Brain RSS Feed" href="http://blog.mozilla.com/axel/feed/" />
<link rel="pingback" href="http://blog.mozilla.com/axel/xmlrpc.php" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://blog.mozilla.com/axel/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.mozilla.com/axel/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Maggot Brain' href='http://blog.mozilla.com/axel/' />
<meta name="generator" content="WordPress 3.1.3" />
</head>
<body>
<div id="outercontainer">
<div id="container">
<div id="header">
<h1><a href="http://blog.mozilla.com/axel">Maggot Brain</a></h1>
<h3>Free your mind and your ass will follow.</h3>
</div>
<div id="menu">
<div id="menumain">
<ul>
<li class="page_item page-item-2"><a href="http://blog.mozilla.com/axel/about/" title="About">About</a></li>
</ul>
</div>
</div>
<div id="main" class="hfeed">
<div class="hentry post" id="post-386">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2011/05/30/coming-soon-cross-repository-network-graphs-for-hg-m-o/" rel="bookmark" title="Permanent Link to Coming soon: cross-repository network graphs for hg.m.o">Coming soon: cross-repository network graphs for hg.m.o</a></h2>	
<p class="entry-date"><abbr class="published" title="2011-05-30T08:05:06">05.30.11 - 08:18am</abbr></p>
<p>Did you miss the ability to look at our source code and figure out who&#8217;s working on what where? Thought that only github can do that?</p>
<p>Let me give you a sneak peek at what I&#8217;ve been hacking on over the weekend.</p>
<p>What&#8217;s the big picture of our mainline code development?</p>
<p><a href="http://www.flickr.com/photos/axelhecht/5775953417/" title="branched repos of mozilla-central by Axel Hecht, on Flickr"><img src="http://farm6.static.flickr.com/5266/5775953417_4a916235f7.jpg" width="500" height="270" alt="branched repos of mozilla-central"></a></p>
<p>You can see the blue line of development along mozilla-central, and then branch points for the release branches, and now for beta (miramar), and aurora. That&#8217;s pretty broad, and intentionally so. If you&#8217;re interested in the back and forth on a changeset level, this is how the branch point of fx5 beta looks:</p>
<p><a href="http://www.flickr.com/photos/axelhecht/5775953715/" title="changesets around the fx5 beta branch point by Axel Hecht, on Flickr"><img src="http://farm3.static.flickr.com/2402/5775953715_7fcd4bb97f.jpg" width="500" height="207" alt="changesets around the fx5 beta branch point"></a></p>
<p>Why does it say aurora? Because hg doesn&#8217;t know what you&#8217;re looking for. I determine what was branched off of what by looking at pushes, wherever a particular changeset was pushed first, wins. As beta branched off of aurora later, you see that this was the branch of aurora at the time.</p>
<p>Sadly, you don&#8217;t see the more interesting detail, that after that branch, the developer tools branch merged. If the database in the backend was tracking our project repos, you&#8217;d see that.</p>
<p>Of course, there&#8217;s also an l10n side to this. I get many questions on what to merge and where and so, and it&#8217;s hard to see what ended up in which repo, and if things are different. Let&#8217;s follow one of the l10n repos at large:</p>
<p><a href="http://www.flickr.com/photos/axelhecht/5775953123/" title="branched repositories of Japanese by Axel Hecht, on Flickr"><img src="http://farm6.static.flickr.com/5185/5775953123_28e98e1bea.jpg" width="500" height="302" alt="branched repositories of Japanese"></a></p>
<p>There&#8217;s even more details on the rapid branches for this one, like so:</p>
<p><a href="http://www.flickr.com/photos/axelhecht/5776494358/" title="changesets around the Japanese fx5 beta branch by Axel Hecht, on Flickr"><img src="http://farm3.static.flickr.com/2745/5776494358_3d4a01c25d.jpg" width="500" height="308" alt="changesets around the Japanese fx5 beta branch"></a></p>
<p>Many of the same landings, but with different hg changesets, and then a merge. That merge didn&#8217;t make it to miramar, though. Which is OK, that&#8217;s a one-off anyway.</p>
<p>Now that I wetted your appetite, bad news: Nothing of this is live yet. I&#8217;ll actually need to make a patch at least for the API in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=659260">bug 659260</a>, get review and get it live. Also, this is currently code that&#8217;s run as part of the l10n dashboard, which isn&#8217;t really intended to cover all our sources. If we want this at large, it&#8217;ll need liberation, and the resources that comes with that. The actual code is pretty easy to liberate, though.</p>
<p>And, graphs are made with <a href="http://vis.stanford.edu/protovis/">protovis</a>, including a custom Network-based layout to do DAGs.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/protovis/" rel="tag">protovis</a> | <a href="http://blog.mozilla.com/axel/2011/05/30/coming-soon-cross-repository-network-graphs-for-hg-m-o/#comments" title="Comment on Coming soon: cross-repository network graphs for hg.m.o">2 Comments &#187;</a></p>
</div>
</div>
<div class="hentry post" id="post-382">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2011/05/10/reviewing-sign-offs-slightly-different/" rel="bookmark" title="Permanent Link to Reviewing sign-offs, slightly different">Reviewing sign-offs, slightly different</a></h2>	
<p class="entry-date"><abbr class="published" title="2011-05-10T03:05:48">05.10.11 - 03:39am</abbr></p>
<p>Opening the magic box of l10n admin stuff:</p>
<p>We&#8217;re doing sign-offs, y&#8217;know? Localizers hit the l10n dashboard and click a button to say &#8220;this revision is good to ship&#8221;. Which is cool, because then they don&#8217;t need approval for every patch for release branch fixes.</p>
<p>And I&#8217;m reviewing the signoffs. Sounds all good, and well proven.</p>
<p>Enter the new release cycle. What&#8217;s new? This is a small update, on a quick turnaround. So I can&#8217;t do what I did for previous releases, and just not review the first sign-off. That was just an early beta (for most locales) and had a 1000 new strings. Sounded fair. Anyway, now we&#8217;re just doing 30 strings, so doing an incremental review against what&#8217;s on 4.0.1 is in order. So what does that mean?</p>
<ol>
<li>I need to get the revision that we&#8217;re shipping on 4.0.1. For sign-offs that update one branch, that&#8217;s all hooked up in the UI, but not for 4.0.x to 5. That&#8217;s <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=655943">bug 655943</a>.</li>
<li>The revision on 4.0.1 is on l10n-mozilla-2.0, the signoff on 5 is on a revision of l10n/mozilla-aurora. Neither need to exist in the other repo, so you can&#8217;t just use plain hg commands on a repo. That&#8217;s <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=655942">bug 655942</a>.</li>
</ol>
<p>Now, I wouldn&#8217;t be me if I wouldn&#8217;t script myself out of it, here&#8217;s the <a href="https://gist.github.com/964230">gist of it</a>. And yes, this blog post is as much code comments as there are for that one.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts in L10n" rel="category tag">L10n</a>, <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/l10n/" rel="tag">L10n</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-377">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2011/04/20/back-home-a-good-deal-lighter/" rel="bookmark" title="Permanent Link to Back home, a good deal lighter">Back home, a good deal lighter</a></h2>	
<p class="entry-date"><abbr class="published" title="2011-04-20T01:04:27">04.20.11 - 01:42am</abbr></p>
<p>Next time you see me, I&#8217;ll look a tad different. That <a href="http://en.wikipedia.org/wiki/Sebaceous_cyst">bump</a> on my head got removed, surgery yesterday went fine, got home today. I&#8217;ll be taking it slow today, but should be up to speed tomorrow.</p>
<p>Thanks to all the good wishes.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> |  | <a href="http://blog.mozilla.com/axel/2011/04/20/back-home-a-good-deal-lighter/#comments" title="Comment on Back home, a good deal lighter">11 Comments &#187;</a></p>
</div>
</div>
<div class="hentry post" id="post-366">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2011/04/11/being-a-localizer-in-the-rapid-release-cycle/" rel="bookmark" title="Permanent Link to Being a localizer in the rapid release cycle">Being a localizer in the rapid release cycle</a></h2>	
<p class="entry-date"><abbr class="published" title="2011-04-11T06:04:03">04.11.11 - 06:15pm</abbr></p>
<p>We&#8217;re changing to a <a href="http://mozilla.github.com/process-releases/">6-week release train model</a>, and this is going to impact how localizers do their contributions. The following scheme has been cycled in .planning for a bit, so this is what we&#8217;ll be doing. We&#8217;ll adapt that if needed, of course, but based on experience with the next cycle or two.</p>
<p>Recap on the rapid release cycle: en-US developers work on <em>mozilla-central</em>, as they used to, and every 6 weeks, we&#8217;ll pull their contributions to another repository, called <a href="http://hg.mozilla.org/releases/mozilla-aurora/">mozilla-aurora</a>. That repository is string frozen. String changes only land in this repository as part of the merge from <em>central</em> to <em>aurora</em>. After another 6 weeks, the content goes to yet another repository, <em>mozilla-beta</em>. Corresponding to those, there&#8217;s <em>l10n/mozilla-aurora</em> and <em>l10n/mozilla-beta</em>. And now you know. Find a glossary at the end of this post.</p>
<p>There are two different localizer schemes: Early birds and friends of string freeze. Read the following descriptions and pick one for your individual localization team.</p>
<p><strong>Early Birds</strong> are those localization teams that are happy to follow the <em>mozilla-central</em> content quickly and make sure that all issues relating to localizing that code are found and fixed. We already have a few of those that have built their reputation among our hackers to have good input to follow. We don&#8217;t need a lot of those, but the ones we have are crucial to make the plan work, and have code that is properly localizable at any time on <em>aurora</em>. You&#8217;ll be following the fx_central tree on the l10n dashboard to catch up on changes.</p>
<p><strong>Friends of String Freeze</strong> are those teams that prefer to have stable content to localize with a decent time window to act on it. Many of our localization teams are in this group. If you&#8217;re in this group, you&#8217;ll set your calendar alarm to the next window, hg pull -u on your <em>mozilla-aurora</em> clone, your <em>l10n/mozilla-aurora</em> clone, localize, push, test, fix, push, sign-off. Then you set your calendar to the next 6-week cycle, and you&#8217;re all set. The expectation here is that the amount of strings will be rather low, so a day of l10n plus testing and fixing is fine. Usually, you should be able to deliver a great localization for the next version of Firefox in some 3 days. Firefox 5 right now is some 30 strings, other releases will be a good deal bigger. But nowhere close the 1.2k strings of Firefox 4. You&#8217;ll be watching the fx_aurora tree on the l10n dashboard to see the status of your localization.</p>
<p>Sign-offs will happen on <em>aurora</em>, in rare cases on <em>beta</em>. The setup where we work towards release is <em>aurora</em>.</p>
<p>What about the <em>beta</em> repositories? Well, I hope to not see a necessity to land on <em>l10n/mozilla-beta</em> for the most part. You should expect that changes you make on <em>l10n/mozilla-beta</em> will be dropped once we do the next update from <em>aurora</em>, so you want to have the fixes on both <em>aurora</em> and <em>beta</em>, if applicable. But really, you want to be good on <em>aurora</em>. Then <em>beta</em> will be fine and no hassle.</p>
<p><strong>How that maps to mercurial work:</strong></p>
<p>For the <strong>Friends of String Freeze</strong>, you&#8217;ll not need to worry about anything other than pulling on both repos every cycle. We&#8217;ll take your content from <em>l10n/mozilla-aurora</em> to <em>l10n/mozilla-beta</em>, and may very well at some point stop doing <em>l10n-central</em> builds at all for you. Just keep things simple here.</p>
<p>For the <strong>Early Birds</strong>, we&#8217;ll rely on you self-identifying and doing a tad of extra work. You&#8217;ll be in best shape to merge your contributions from <em>l10n-central</em> to <em>l10n/mozilla-aurora</em>, making sure that the result has all your fixes from both <em>central</em> and <em>aurora</em>, where you want them. You&#8217;re techy-geeky-savvy anyways, so that&#8217;s allright. If at some point, we learn that there&#8217;s a pattern that benefits from automation, we&#8217;ll check in on that when we get there, too. You shouldn&#8217;t have to worry about getting content on <em>l10n/mozilla-beta</em> anymore than the rest, though.</p>
<p><strong>Glossary</strong>:<br />
<a href="http://hg.mozilla.org/mozilla-central/"><em>mozilla-central</em></a> is the mercurial repository that en-US code is landed to as development makes progress.<br />
<a href="http://hg.mozilla.org/l10n-central/"><em>l10n-central</em></a> is the tree of mercurial repositories that the early-bird localizers use as development makes progress.<br />
<em>central</em> is short for either, or both, of mozilla-central and l10n-central, depending on context.</p>
<p>The terms around <a href="http://hg.mozilla.org/releases/mozilla-aurora/"><em>mozilla-aurora</em></a>, <a href="http://hg.mozilla.org/releases/l10n/mozilla-aurora/"><em>l10n/mozilla-aurora</em></a>, and <em>aurora</em> map to their corresponding terms for <em>central</em>, same for <a href="http://hg.mozilla.org/releases/mozilla-beta/"><em>mozilla-beta</em></a>, <a href="http://hg.mozilla.org/releases/l10n/mozilla-beta/"><em>l10n/mozilla-beta</em></a>, and <em>beta</em>.</p>
<p><strong>Update</strong>: Fixed the links to map to the new and stable repository locations.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts in L10n" rel="category tag">L10n</a>, <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/l10n/" rel="tag">L10n</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-361">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/11/24/compare-locales-0-9-1-is-out/" rel="bookmark" title="Permanent Link to compare-locales 0.9.1 is out">compare-locales 0.9.1 is out</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-11-24T07:11:42">11.24.10 - 07:30am</abbr></p>
<p>I released compare-locales 0.9.1 yesterday on pypi. Do the regular</p>
<blockquote><p><code>easy_install -U compare-locales</code></p></blockquote>
<p>to update your local copy.</p>
<p>This update includes two bug-fixes compared to <a href="http://blog.mozilla.com/axel/2010/10/04/cl09/">0.9</a>, </p>
<ul>
<li>Don&#8217;t warn about XML-defined entities like &amp;amp;, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=604404">bug 604404</a></li>
<li>Ensure that merged entities have a trailing newline, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=612619">bug 612619</a></li>
</ul>
<p>In particular the latter will make our l10n-merge code more stable. Sadly, we actually need to fix all the newly-reported errors in all stable branches and apps before we can update the production tag. Errors make compare-locales fail, and rightfully so. And fail is bad for release builds that don&#8217;t merge, also rightfully so.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts in L10n" rel="category tag">L10n</a>, <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/l10n/" rel="tag">L10n</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-351">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/11/15/as-sure-as-logs-are-logs/" rel="bookmark" title="Permanent Link to As sure as logs are logs">As sure as logs are logs</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-11-15T12:11:39">11.15.10 - 12:04pm</abbr></p>
<p>&#8230; or not.</p>
<p>As promised, I&#8217;ll write a bit about build logs today. You&#8217;ll see what our logs are, and, to begin with, I&#8217;ll take you on a tour through <code><a href="http://hg.mozilla.org/build/buildbot/file/b7b751d9df42/master/buildbot/status/tinderbox.py#l137">buildMessage</a></code> to explain how the logs we have end up being what you see served off of tinderbox.</p>
<p>First off, buildbot is basically the same thing as any regular gecko app, one main thread and loads of callbacks. So when reading on, all your spontanous reactions are good.</p>
<p>The <code>buildMessage</code> code does:</p>
<ol>
<li>synchronous IO to load all logs of a build into memory, basically up to some 70M</li>
<li>synchronous string handling to paste all that data together, with some extra padding</li>
<li>synchronous compression of the resulting string</li>
<li>synchronous base64 encoding of the compressed string</li>
</ol>
<p>All on the main thread, all in one go, blocking. All of that to give you a single lengthy unformatted blob of text. Why?</p>
<p>Because our build logs are actually not a single lengthy unformatted blob of text, which is what tinderbox wants.</p>
<p>Let&#8217;s have a peek into what our build logs are, really. In my previous posts, I introduced you to the concept of build steps. They&#8217;re really the basic entity of work to be done for a build. Now, the logs are stored in buildbot pretty much in how the data comes, that is, each log is associated with a step, and the storage is happening as the chunks arrive. Commonly, that&#8217;d be stdout and stderr data coming from shell commands run on the slave. The information about which stream the data is on is persisted, too, as is the order, so any log looks like this, basically:</p>
<table cellspacing="0" cellpadding="5" border="1">
<tr>
<td rowspan="6" style="vertical-align: top;">Step reference</td>
<td><em>header</em></td>
<td>length</td>
<td>data</tr>
</tr>
<tr>
<td><em>stdout</em></td>
<td>length</td>
<td>data</tr>
</tr>
<tr>
<td><em>stdout</em></td>
<td>length</td>
<td>data</tr>
</tr>
<tr>
<td><em>stdout</em></td>
<td>length</td>
<td>data</tr>
</tr>
<tr>
<td><em>stderr</em></td>
<td>length</td>
<td>data</tr>
</tr>
<tr>
<td><em>stdout</em></td>
<td>length</td>
<td>data</tr>
</tr>
</table>
<p>As most of you aren&#8217;t among the few priviledged ones to actually look at the real logs, I&#8217;ve set up a fake log page for you to take a look. It&#8217;s an l10n repack, mostly because they&#8217;re somewhat small in both step count and log size, and because I&#8217;m used to them. Here&#8217;s the <a href="http://people.mozilla.org/~axel/logs-example/#repack_installers">actual make step</a> highlighted. You can see the introduction being shown in blue, which is the common color for <em>header</em> chunks. Buildbot just uses that channel to show setup and shutdown information on the step. Then there&#8217;s the actual make output in black. If there was something on stderr, it&#8217;d be styled in red. Sorry, I didn&#8217;t quickly come up with something that has stderr.</p>
<p>The first take-away is  that you can get to just the build output of the step you&#8217;re interested in.</p>
<p>If you&#8217;re nostalgic, you can check the checkbox for tinderbox, the css style sheet changes to show you what you&#8217;d get from tinderbox. Try to find the information again?</p>
<p>One further detail, there can be more than one log per step. Buildsteps that set build properties quite commonly have two logs, one that keeps track of the command that got run, and another that keeps track of the actually changed build properties. You can look at an example in the <a href="http://people.mozilla.org/~axel/logs-example/#set_builddir">builddir step</a>. The boring last line is the second log.</p>
<p>Log files are really not all that complicated, and much more useful than what we get back from tinderbox. Let&#8217;s look at some of the pros:</p>
<p>Log files come in as the build goes. This enables buildbot to publish build logs in almost realtime. There&#8217;s little-to-no cost for that, too, a simple node.js proxy can ensure that only one log is read at any time. Another benefit is, one can archive logs incrementally, removing the current stress on the masters to publish more data than they want to chew in one go.</p>
<p>Log files are per task. As the logs are associated with a step, which has a name and a builder, there&#8217;s pretty rich information available on what the data in question is actually about. Think about hg-specific error parsers for one step, ftp-specific ones for the next, and mochitest-specific ones for the one after that. All in one build. If we&#8217;d archive the raw data, we can easily improve our parsers and be compatible with old logs. Or add new steps to the build process without fear to break existing log parsers.</p>
<p>Tinderbox can still be fed. Even if we&#8217;re not sending out tinderbox log mails from the masters, we can still do the processing out of band in an external process or even external machine, offload the masters, and not enforce us to change all infrastructure in one go.</p>
<p>There is a hard piece, too, storage. Build logs are plenty, and they&#8217;re anywhere from a dozen bytes to 70M. Within the same build, even. There a hundreds of thousands small files, and thousands of really large ones. I hope that adding some information on what our build logs really are helps to spike a design discussion on this. If to compress, on which level. Retention, per step type, even? Store as single files, in one dir, or in a hierarchy, or as tar balls? Or all of the above as part of retention? Is hbase a fit?</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/build/" rel="tag">build</a>, <a href="http://blog.mozilla.com/axel/tag/buildbot/" rel="tag">buildbot</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-344">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/11/12/counting-sourcestamps-changes-and-faking-data/" rel="bookmark" title="Permanent Link to Counting sourcestamps, changes, and faking data">Counting sourcestamps, changes, and faking data</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-11-12T08:11:34">11.12.10 - 08:31am</abbr></p>
<p>As a follow up to my <a href="http://blog.mozilla.com/axel/2010/11/10/looking-at-the-internals-of-our-builds/">previous post</a> on my digging through our build status, I want to look with a bit more detail, pretend it&#8217;d all be simple and what it could be, and, well, add the promised chocolate to coconut. Bounty.</p>
<p>Let&#8217;s look at the actual data for two and half landings. First, I&#8217;ll start with a rather simple landing by roc, <a href="http://hg.mozilla.org/mozilla-central/pushloghtml?changeset=1b43ce0bda4fae">revision 1b43&#8230; on mozilla-central</a>. Let me summarize the <a href="http://l10n.mozilla.org/coconut/sources?revision=1b43ce0bda4fae9292f63c253af44f3794d62604&#038;count=200">builds</a> real quick:</p>
<p>1 changeset in 1 push.</p>
<p>27 change rows in status db.</p>
<p>16 different branch names.</p>
<p>106 sourcestamps in status db.</p>
<p>245 builds.</p>
<p>That&#8217;s a lot, because, what we&#8217;re really interested in is </p>
<p>1 push, 245 builds.</p>
<p>Talk is cheap, but what&#8217;s really cheap is manipulating other peoples database, so while Vettel was running in circles in Brazil, I was running circles in the db and manually stitched things back together. The result is still coconut, but with chocolate, so here is the <a href="http://l10n.mozilla.org/bounty/sources?revision=1b43ce0bda4fae9292f63c253af44f3794d62604&#038;count=200">same url in bounty</a>.</p>
<p>1 source, 1 change, 253 builds.</p>
<p>Wait, what, not 245? No, 253, because, well, there are more disconnects in the status, so the query in the database doesn&#8217;t catch them all. That&#8217;s what you need manual stitching for. Also, finding the right sourcestamp to keep isn&#8217;t trivial.</p>
<p>Which is why I only did it for a few builds. Sorry, you&#8217;ll not find a lot of builds that are stitched together, so enjoy the guided tour through the few shiny places.</p>
<p>During my needlework I came across another set of changes which are worthwhile to include into today&#8217;s tour. It&#8217;s two pushes, by <a href="http://hg.mozilla.org/mozilla-central/pushloghtml?changeset=3f499de2401d">khuey</a> and <a href="http://hg.mozilla.org/mozilla-central/pushloghtml?changeset=30a1be9d442a">vlad</a>. Let&#8217;s give Count Count a rest and look at them with chocolate right away, the builds for <a href="http://l10n.mozilla.org/bounty/sources?revision=3f499de2401d0e9e02fc644ff574ae103e3a394a">khuey&#8217;s revision</a> and <a href="http://l10n.mozilla.org/bounty/sources?revision=30a1be9d442a98adb4a2095f9c8ee1808dd29560">vlad&#8217;s</a>. What you&#8217;ll notice is that some of the builds for khuey aren&#8217;t there, but lumped together with vlad&#8217;s. Why&#8217;s that?</p>
<p>Our build infrastructure really doesn&#8217;t know about pushes. As I&#8217;ve detailed in my previous post, there are sourcestamps and changes, but no further grouping. At this point it&#8217;s really a design decision on whether the buildbot changes are hg pushes or hg changesets. This decision is currently in favor of hg changesets, which may just be right. At that point, the scheduling logic that puts changes into builds needs to put extra care into creating sourcestamps for what we intend to get builds for, and to keep those sourcestamps apart. The current implementation puts anything coming in within three minutes into the same sourcestamp, which is <em>somewhat</em> of a load limiter.</p>
<p>Anyway, back to chocolate. When you looked at the pages, did you realize that once you add it, you&#8217;re almost at a tinderboxpushlog page? Right, it could be that &#8220;easy&#8221;.</p>
<p>What&#8217;s between reality and chocolate? Well, <code>sendchange</code>. That&#8217;s a buildbot architecture component that allows shell commands to insert changes into buildmaster. It&#8217;s rather limited in the data it can transport, which is why we loose data on the way. There&#8217;s an alternative feature called <code>trigger</code>, which doesn&#8217;t. There is an <a href="http://buildbot.net/trac/ticket/1039">open ticket</a> to make that span different buildmasters, but given how much Mozilla invested into schedulerdb, let&#8217;s pray it&#8217;s easy to fix. Filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=611670">bug 611670</a>.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/build/" rel="tag">build</a>, <a href="http://blog.mozilla.com/axel/tag/buildbot/" rel="tag">buildbot</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-338">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/11/10/looking-at-the-internals-of-our-builds/" rel="bookmark" title="Permanent Link to Looking at the internals of our builds">Looking at the internals of our builds</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-11-10T09:11:47">11.10.10 - 09:34am</abbr></p>
<p>Chris Atlee has put up database dumps of both the <a href="https://wiki.mozilla.org/ReleaseEngineering/BuildAPI">scheduler and the status databases</a>. These databases are the most detailed and (almost, status db is not) first class information on what our builds are really doing. The current code on top of that is all pylons-based, and I am, as many other mozillians, part of the django shop. So for one I figured &#8220;let&#8217;s see if I can make django read this&#8221;.</p>
<p>I can. It&#8217;s a bit rough, though, as some of the tables for many-to-many relationships don&#8217;t contain a primary key column. Django really doesn&#8217;t like that, and thus there are some things that you cannot do without those columns. Most of it works just fine, though. This holds at least for the status db, which I looked at in more detail, but the scheduler db ain&#8217;t much different. Filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=611014">bug 611014</a>.</p>
<p>The code for this is up at <a href="https://github.com/Pike/django_moz_status">django_moz_status on github</a>.</p>
<p>Of course, me being able to talk to the db with a python shell won&#8217;t help you much, right? So I&#8217;ve spent a few more hours to actually create a really rough website on top of it, which I want to share with you.</p>
<p>Coconut. Hard to open, and once you get there, you may not like it. I have a thing with project names.</p>
<p><a href="https://github.com/Pike/coconut">Coconut</a> is a bunch of django views on top of django_moz_status, held together by <a href="https://github.com/Pike/site_demo">site_demo</a>. You can see it in action (for now) on the <a href="http://l10n.mozilla.org/coconut/sources?count=50&#038;offset=1362437&#038;exclude_empty&#038;branch=mozilla-central">l10n community server</a>. This view is exposing three concepts of buildbot, and how they play together:</p>
<p>Sourcestamps (first column): Every build in buildbot has a sourcestamp, and a sourcestamp can have multiple builds. The sourcestamp knows a branch, a revision, and a list of changes going into the builds associated with it.</p>
<p>Changes (second column): Changes are the external &#8220;real life&#8221; events that may or may not trigger builds. In this view, you see a few list of changes that look like a push to hg (and are just that), as well as a plethora of changes by Mr. sendchange, and Mr. sendchange-unittest. If you remove some query params on the above URL, you can also see a <a href="http://l10n.mozilla.org/coconut/sources?count=50&#038;offset=1362437">bunch of sourcestamps without changes</a>. Those are nightlies.</p>
<p>Builds (last column): Each sourcestamp can have multiple builds, I&#8217;m just showing the builder name (a symbolic short name), the buildnumber, and the result as color. The third column is actually a guess on the platform of the build, based on the <code>platform</code> build property. If that&#8217;s not set, <code>unknown</code> is used.</p>
<p>Which brings me nicely to another two pieces of our build infrastructure that has been hard to look at so far. Build steps and build properties. Surf along? Let&#8217;s look at <a href="http://l10n.mozilla.org/coconut/build/1894077">a build</a>.</p>
<p>The first section of the build pages shows some general information, builder, buildnumber, status. The start and end time, how long the build took. Also it lists the buildbot master, and the category of the builder. Categories allow to filter for builds, sadly, a builder can only be in one category.</p>
<p>Next up is build steps. Each step in a build is an item of work, and an entity of failure. Different steps can handle failures differently, too. You can see that the build starts with a flock of steps that do administrative tasks on the slave. You can see which fragment of time of the build that step took by looking at the bar in the second column. You&#8217;ll see that the majority of that build went into the compile step. And that that passed. And after that compile, there&#8217;s a bunch of adminstrative stuff again.</p>
<p>There are two things that you do not see. One is, each of those steps has build logs attached to them. Commonly one, but possibly more. I&#8217;ll talk more about logs in a different post. The other thing is, steps can change the build properties. Which is to say, the build properties which are shown at the end of the build page are not static, but change during the build run.</p>
<p>Build properties? Right, within buildbot, several objects can have properties, among them, builds. You&#8217;ll find things like the buildnumber, the slavename, the branch, buildername (pretty). You&#8217;ll also find a host of things around the packaging of the build. Quite generally, our build try to put things that are needed for the build itself or for logic around into build properties.</p>
<p>The end of the page is reiterating which changes are associated with the sourcestamp for this build.</p>
<p>Let me stress your patience once more and invite you to visit a <a href="http://l10n.mozilla.org/coconut/build/1893242">build with a failed step</a>. In this build page you can see how the clobber step worked fine, and took quite some time, and the actual status of the build is due to the actual test step failing with a warning.</p>
<p>Now this post is already pretty lengthy, so I&#8217;ll take a break here and invite you to go in and click back and forth a bit, and to do some url hacking. If you think this is rough and you&#8217;re having a hard time figuring out what&#8217;s why, I&#8217;ll do a follow up post on how to add chocolate to coconut.</p>
<p>PS: the database this instance is working on is a snapshot that ends in August, details may be different today. I shrunk the database, too, only the last 10k builds still have the buildsteps.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/build/" rel="tag">build</a>, <a href="http://blog.mozilla.com/axel/tag/buildbot/" rel="tag">buildbot</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <a href="http://blog.mozilla.com/axel/2010/11/10/looking-at-the-internals-of-our-builds/#comments" title="Comment on Looking at the internals of our builds">2 Comments &#187;</a></p>
</div>
</div>
<div class="hentry post" id="post-329">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/11/05/multilingualweb-workshop-in-madrid/" rel="bookmark" title="Permanent Link to MultilingualWeb: Workshop in Madrid">MultilingualWeb: Workshop in Madrid</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-11-05T08:11:04">11.05.10 - 08:24am</abbr></p>
<p>So I&#8217;ve been at the W3 MultilingualWeb <a href="http://www.w3.org/International/multilingualweb/madrid/madrid-results.html">Workshop in Madrid</a> last week, and I guess there are a few things worth reporting.</p>
<p><a href="http://www.multilingualweb.eu/">MultilingualWeb</a> is a project bound to host 4 workshops to bring people from different fields together to see how standards and best practices (existing and not) can help the web. Being mozilla, we don&#8217;t really need to add that it&#8217;s beyond just one language, right? The effort is strongly supported by the European Union, so there&#8217;s a bias towards participants in these workshops being from Europe, though the folks by themselves certainly talk beyond that.</p>
<p>The crowd in Madrid was really diverse, standards people, government (EU and India), researchers, content, and, well, browsers. The browsers people were Charles McCathieNevile (Opera), Jan Nelson and Peter Constable (Microsoft), and me (Mozilla). There we no folks from webkit-based browsers.</p>
<p>Interesting bits and pieces:</p>
<p>I guess other people made that experience lately, too, but I welcome the way that MSFT is positioning themselves lately. Now they just need to compare beta builds to beta builds, and, (insider joke) while we hack on canvas, you learn JS:</p>
<blockquote><p><code>- ctx = canvas1.getContext("2d");<br />
+ ctx = document.getElementById('canvas1').getContext("2d");</code></p></blockquote>
<p>Still need to actually look at the results in competing browsers, and not on my font-broken OSX, but we&#8217;re not doing too bad.</p>
<p>Gecko should really start using <a href="http://cldr.unicode.org/">CLDR</a> data for stuff like plurals, dates, calendars, lists. I should also really read up on <a href="http://wiki.ecmascript.org/doku.php?id=strawman:i18n_api">ES&#8217; i18n_api</a>.</p>
<p>It was interesting to see common questions on what&#8217;s a language from Denis Gikunda, who&#8217;s working on l10n for google in sub-saharan Africa. Now that Anloc is coming in with their localizations, we&#8217;re getting more exposed to how the history of those languages is so different from European ones.</p>
<p>Facebook&#8217;s Ghassan Haddad reported on a few interesting things. Like Zuckerman coming into his interview with &#8220;you can&#8217;t slow our development down&#8221;. Interesting about this is that the resulting infrastructure is far from zero-impact on the development. There are quite some restrictions on what content you can put up, and you have to add syntactic sugar all over, too. Go check <a href="http://developers.facebook.com/docs/internationalization">their docs</a> for details. Also, they&#8217;re not slowing down the publishing of localizations.</p>
<p>We got a bit of detail in the discussion about vandalism in fb l10n. They initially relied on community there, but when they got hit, they took down the localized sites until they had tooling support. Ghassan didn&#8217;t come forward with details on what they do, though.</p>
<p>They are doing something conceptually similar to l20n to localize their social messages like &#8220;A is now friend with B, C&#8221;, to make those depend on all the genders. IIRC, they call it string or entity <em>explosion</em>. Didn&#8217;t get to ask any questions about this one, sadly.</p>
<p>Most of the science people talked about processes that all sound very good for the data we get from feedback in Firefox 4 betas. Natural language processing with trends detection, &#8220;translation&#8221; of SMS Spanish into Spanish, and much more. Sadly, there&#8217;s nothing shrink wrapped that we could just use, but there&#8217;s interest in creating a project to find out, maybe for Firefox Next?</p>
<p>One thing that felt slightly odd was the Semantic Web. I thought that was dead, but there&#8217;s still optimism around that. Maybe semantics that help machine translation make a case for it, I&#8217;m not sure. Also, there seems to be more structured data coming to the &#8220;public web&#8221;, and the algorithms that transform the &#8220;hidden web&#8221; into the &#8220;public web&#8221; could more easily add markup than human authors would. Still, there wasn&#8217;t much hope in the browser people. Luckily, the browser doesn&#8217;t really need to do anything but creating a DOM, and passing markup around for machine translation engines taking benefit from additional semantics.</p>
<p>Last but not least, I did finally get to spend some quality time with our Madrid community, thanks to the folks for taking me out twice. I had a great time, and sorry that my English speaking tempo aligned with your Spanish speaking tempo way too often :-). </p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts in L10n" rel="category tag">L10n</a>, <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/l10n/" rel="tag">L10n</a>, <a href="http://blog.mozilla.com/axel/tag/mlw/" rel="tag">mlw</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <span>Comments Off</span></p>
</div>
</div>
<div class="hentry post" id="post-313">
<div class="entry-content">
<h2 class="entry-title"><a href="http://blog.mozilla.com/axel/2010/10/04/cl09/" rel="bookmark" title="Permanent Link to Releasing compare-locales 0.9, aka, the value checker">Releasing compare-locales 0.9, aka, the value checker</a></h2>	
<p class="entry-date"><abbr class="published" title="2010-10-04T09:10:55">10.04.10 - 09:06am</abbr></p>
<p>I&#8217;ve just uploaded version <a href="http://pypi.python.org/pypi/compare-locales/0.9">0.9 of compare-locales onto pypi</a>. It&#8217;s finally the version that does all the fancy value checks that I&#8217;ve been talking about for a while, and that some of the localizers have seen flying by in their bugmail.</p>
<p>Here&#8217;s what it does:</p>
<p>For DTDs, I create fake xml docs, and try to parse them. This should find encoding errors, as well as unbalanced XML tags or stray &#8216;&#038;&#8217; ampersands. There&#8217;s one thing that&#8217;s tricky, and that is references to entities. I do get the list of entities from en-US, so I do have a good idea which should work (really, please). On the other hand, referencing other entities may not be an error. &rdquot; for example could be totally fine. If referenced in an XHTML document, that is. Not if it was included in a XUL document. Of course both breeds could include the same DTD file. I can&#8217;t really tell, so I&#8217;ve added a new category of reporting, called <em>warnings</em>.</p>
<p>For properties files, I check a bunch of printf tricks. Some of those are warnings, some of those are errors. Which is which basically depended on code-inspection. I also did some heuristics based on comments referencing the plural docs to check for our plurals-special variable handling.</p>
<p>Outstanding are the installer variable checks still, didn&#8217;t want to hold back this release for that. They&#8217;re somewhat tricky in the details and yet more tedious to get right than the other checks.</p>
<p>What does that mean for localizers? You wanna get the error count down to zero. The warnings count may or may not go down to zero, that&#8217;s your call.</p>
<p>The new version isn&#8217;t in public use anywhere yet, the deployment will go like this:</p>
<ul>
<li>Get a round of public feedback on this release.</li>
<li>Use on the dashboard (likely gonna happen when I do the 2.0 branch dance, too).</li>
<li>Try to get the new version used on the build system.</li>
</ul>
<p>Please give the new version a bit of pounding in your local l10n-merge builds, too. It should strip entities with errors from your localization, and merge in <code>en-US</code> strings for that.</p>
<p>Feel free to <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Mozilla%20Localizations&#038;component=Infrastructure&#038;rep_platform=All&#038;op_sys=All&#038;short_desc=[compare-locales]">file bugs</a> on issues you find.</p>
<p class="entry-meta"> Category: <a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts in L10n" rel="category tag">L10n</a>, <a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts in Mozilla" rel="category tag">Mozilla</a> | Tags: <a href="http://blog.mozilla.com/axel/tag/l10n/" rel="tag">L10n</a>, <a href="http://blog.mozilla.com/axel/tag/mozilla/" rel="tag">Mozilla</a> | <a href="http://blog.mozilla.com/axel/2010/10/04/cl09/#comments" title="Comment on Releasing compare-locales 0.9, aka, the value checker">1 Comment &#187;</a></p>
</div>
</div>
<!--The navigation.php was written by Chris Pearson for the Cutline Theme [http://cutline.tubetorial.com/], a great theme and worth a hard look   Please do not delete this message.  -->

<div class="navigation">
	<div class="previous"><a href="http://blog.mozilla.com/axel/page/2/" > &larr; Previous Entries</a></div>
	<div class="next"></div>
</div>
<div class="clear"></div>

</div>
<div id="sidebar">
<li id="categories-3" class="widget widget_categories"><h2 class="widgettitle">Categories</h2>
		<ul>
	<li class="cat-item cat-item-23"><a href="http://blog.mozilla.com/axel/category/eclipse/" title="View all posts filed under Eclipse">Eclipse</a>
</li>
	<li class="cat-item cat-item-145"><a href="http://blog.mozilla.com/axel/category/fossin2007/" title="View all posts filed under fossin2007">fossin2007</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://blog.mozilla.com/axel/category/l10n/" title="View all posts filed under L10n">L10n</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://blog.mozilla.com/axel/category/mozilla/" title="View all posts filed under Mozilla">Mozilla</a>
</li>
	<li class="cat-item cat-item-630"><a href="http://blog.mozilla.com/axel/category/ott09/" title="View all posts filed under ott09">ott09</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://blog.mozilla.com/axel/category/rdf/" title="View all posts filed under RDF">RDF</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://blog.mozilla.com/axel/category/uncategorized/" title="View all posts filed under Uncategorized">Uncategorized</a>
</li>
		</ul>
</li>
<li id="text-3" class="widget widget_text">			<div class="textwidget"><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array' title='JavaScript JS Documentation: JS Array shift, JavaScript Array shift, JS Array .shift, JavaScript Array .shift'><img src='http://static.jsconf.us/promotejshs.png' height='150' width='180'></a></div>
		</li>
<!--ends sidebar widgets-->
</ul>
</div><div id="footer">
<div id="footerleft">
</div>
<div id="footerright">
</div>
<div class="flickr">
</div>
<div id="credits">
<p><a href="http://wordpress.com" title="Get down with the Cosmic Power of the Monkey God">wordpress</a> | design: <a title="derby web design" href="http://www.tristarwebdesign.co.uk/">tristar</a> | port: <a href="http://journal.barleyhut.com">a.m. griffin</a> | icons: <a href="http://iconkits.com">iconkits</a></p>
</div>
</div>
</div>
</div>
<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>1557</strong>  Spams eaten and counting...</div><script defer src="http://blog.mozilla.com/axel/wp-content/js/webtrends/webtrends-v0.1.js"></script><noscript><div><img alt="DCSIMG" id="DCSIMG" width="1" height="1" src="http://statse.webtrendslive.com/dcsfnk37m00000gss18cknplo_6g5c/njs.gif?dcsuri=/nojavascript&amp;WT.js=No&amp;WT.tv=8.6.2"/></div></noscript></body>
</html>
