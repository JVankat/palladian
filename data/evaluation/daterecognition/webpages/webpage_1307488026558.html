<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.1" />
		<meta name="keywords" content="Paper" />
		<link rel="alternate" type="application/x-wiki" title="Edit" href="/index.php?title=Paper&amp;action=edit" />
		<link rel="edit" title="Edit" href="/index.php?title=Paper&amp;action=edit" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="Linux-VServer (en)" />
		<link title="Creative Commons" type="application/rdf+xml" href="/index.php?title=Paper&amp;action=creativecommons" rel="meta" />
		<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html" />
		<link rel="alternate" type="application/rss+xml" title="Linux-VServer RSS Feed" href="/index.php?title=Special:RecentChanges&amp;feed=rss" />
		<link rel="alternate" type="application/atom+xml" title="Linux-VServer Atom Feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom" />
		<title>Paper - Linux-VServer</title>
    <link rel="stylesheet" href="/skins/common/shared.css?207" type="text/css" media="screen" />
		<link rel="stylesheet" href="/skins/common/commonPrint.css?207" type="text/css" media="print" />
		<link rel="stylesheet" href="/skins/vwiki/main.css?207" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="/skins/vwiki/IE50Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="/skins/vwiki/IE55Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="/skins/vwiki/IE60Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="/skins/vwiki/IE70Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" />
		<link rel="stylesheet" href="/index.php?title=MediaWiki:Print.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" media="print" />
		<link rel="stylesheet" href="/index.php?title=MediaWiki:Vwiki.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" />
		<link rel="stylesheet" href="/index.php?title=-&amp;action=raw&amp;maxage=18000&amp;gen=css" type="text/css" />		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "vwiki";
		var stylepath = "/skins";
		var wgArticlePath = "/$1";
		var wgScriptPath = "";
		var wgScript = "/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://linux-vserver.org";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Paper";
		var wgTitle = "Paper";
		var wgAction = "view";
		var wgArticleId = "1414";
		var wgIsArticle = true;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 4652;
		var wgVersion = "1.15.1";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="/skins/common/wikibits.js?207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="/skins/common/ajax.js?207"></script>
		<script type="text/javascript" src="/index.php?title=-&amp;action=raw&amp;gen=js&amp;useskin=vwiki"><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Paper skin-vwiki">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">Paper</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From Linux-VServer</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content -->
			<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Abstract"><span class="tocnumber">1</span> <span class="toctext">Abstract</span></a></li>
<li class="toclevel-1"><a href="#Introduction"><span class="tocnumber">2</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1"><a href="#The_Concept"><span class="tocnumber">3</span> <span class="toctext">The Concept</span></a></li>
<li class="toclevel-1"><a href="#Existing_Infrastructure"><span class="tocnumber">4</span> <span class="toctext">Existing Infrastructure</span></a>
<ul>
<li class="toclevel-2"><a href="#Linux_Capability_System"><span class="tocnumber">4.1</span> <span class="toctext">Linux Capability System</span></a>
<ul>
<li class="toclevel-3"><a href="#POSIX_Capabilities"><span class="tocnumber">4.1.1</span> <span class="toctext">POSIX Capabilities</span></a></li>
<li class="toclevel-3"><a href="#Capability_Overview"><span class="tocnumber">4.1.2</span> <span class="toctext">Capability Overview</span></a></li>
</ul>
</li>
<li class="toclevel-2"><a href="#Resource_Limits"><span class="tocnumber">4.2</span> <span class="toctext">Resource Limits</span></a>
<ul>
<li class="toclevel-3"><a href="#Limit-able_Resource_Overview"><span class="tocnumber">4.2.1</span> <span class="toctext">Limit-able Resource Overview</span></a></li>
</ul>
</li>
<li class="toclevel-2"><a href="#File_Attributes"><span class="tocnumber">4.3</span> <span class="toctext">File Attributes</span></a></li>
<li class="toclevel-2"><a href="#The_chroot.281.29_Command"><span class="tocnumber">4.4</span> <span class="toctext">The chroot(1) Command</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Required_Modifications"><span class="tocnumber">5</span> <span class="toctext">Required Modifications</span></a>
<ul>
<li class="toclevel-2"><a href="#Context_Separation"><span class="tocnumber">5.1</span> <span class="toctext">Context Separation</span></a></li>
<li class="toclevel-2"><a href="#Network_Separation"><span class="tocnumber">5.2</span> <span class="toctext">Network Separation</span></a></li>
<li class="toclevel-2"><a href="#The_Chroot_Barrier"><span class="tocnumber">5.3</span> <span class="toctext">The Chroot Barrier</span></a></li>
<li class="toclevel-2"><a href="#Upper_Bound_for_Caps"><span class="tocnumber">5.4</span> <span class="toctext">Upper Bound for Caps</span></a></li>
<li class="toclevel-2"><a href="#Resource_Isolation"><span class="tocnumber">5.5</span> <span class="toctext">Resource Isolation</span></a></li>
<li class="toclevel-2"><a href="#Filesystem_XID_Tagging"><span class="tocnumber">5.6</span> <span class="toctext">Filesystem XID Tagging</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Additional_Modifications"><span class="tocnumber">6</span> <span class="toctext">Additional Modifications</span></a>
<ul>
<li class="toclevel-2"><a href="#Context_Flags"><span class="tocnumber">6.1</span> <span class="toctext">Context Flags</span></a></li>
<li class="toclevel-2"><a href="#Context_Capabilities"><span class="tocnumber">6.2</span> <span class="toctext">Context Capabilities</span></a></li>
<li class="toclevel-2"><a href="#Context_Accounting"><span class="tocnumber">6.3</span> <span class="toctext">Context Accounting</span></a></li>
<li class="toclevel-2"><a href="#Context_Limits"><span class="tocnumber">6.4</span> <span class="toctext">Context Limits</span></a></li>
<li class="toclevel-2"><a href="#Virtualization"><span class="tocnumber">6.5</span> <span class="toctext">Virtualization</span></a></li>
<li class="toclevel-2"><a href="#Improved_Security"><span class="tocnumber">6.6</span> <span class="toctext">Improved Security</span></a></li>
<li class="toclevel-2"><a href="#Kernel_Helper"><span class="tocnumber">6.7</span> <span class="toctext">Kernel Helper</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Features_and_Bonus_Material"><span class="tocnumber">7</span> <span class="toctext">Features and Bonus Material</span></a>
<ul>
<li class="toclevel-2"><a href="#Unification"><span class="tocnumber">7.1</span> <span class="toctext">Unification</span></a></li>
<li class="toclevel-2"><a href="#Private_Namespaces"><span class="tocnumber">7.2</span> <span class="toctext">Private Namespaces</span></a></li>
<li class="toclevel-2"><a href="#The_Linux-VServer_Proc-FS"><span class="tocnumber">7.3</span> <span class="toctext">The Linux-VServer Proc-FS</span></a></li>
<li class="toclevel-2"><a href="#Token_Bucket_Extensions"><span class="tocnumber">7.4</span> <span class="toctext">Token Bucket Extensions</span></a></li>
<li class="toclevel-2"><a href="#Context_Disk_Limits"><span class="tocnumber">7.5</span> <span class="toctext">Context Disk Limits</span></a></li>
<li class="toclevel-2"><a href="#Per-Context_Quota"><span class="tocnumber">7.6</span> <span class="toctext">Per-Context Quota</span></a></li>
<li class="toclevel-2"><a href="#The_VRoot_Proxy_Device"><span class="tocnumber">7.7</span> <span class="toctext">The VRoot Proxy Device</span></a></li>
<li class="toclevel-2"><a href="#Stealth"><span class="tocnumber">7.8</span> <span class="toctext">Stealth</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Linux-VServer_Security"><span class="tocnumber">8</span> <span class="toctext">Linux-VServer Security</span></a>
<ul>
<li class="toclevel-2"><a href="#Secure_Capabilities"><span class="tocnumber">8.1</span> <span class="toctext">Secure Capabilities</span></a></li>
<li class="toclevel-2"><a href="#The_Chroot_Barrier_2"><span class="tocnumber">8.2</span> <span class="toctext">The Chroot Barrier</span></a></li>
<li class="toclevel-2"><a href="#Secure_Device_Nodes"><span class="tocnumber">8.3</span> <span class="toctext">Secure Device Nodes</span></a></li>
<li class="toclevel-2"><a href="#Secure_Proc-FS_Entries"><span class="tocnumber">8.4</span> <span class="toctext">Secure Proc-FS Entries</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Field_of_Application"><span class="tocnumber">9</span> <span class="toctext">Field of Application</span></a>
<ul>
<li class="toclevel-2"><a href="#Administrative_Separation"><span class="tocnumber">9.1</span> <span class="toctext">Administrative Separation</span></a></li>
<li class="toclevel-2"><a href="#Service_Separation"><span class="tocnumber">9.2</span> <span class="toctext">Service Separation</span></a></li>
<li class="toclevel-2"><a href="#Enhancing_Security"><span class="tocnumber">9.3</span> <span class="toctext">Enhancing Security</span></a></li>
<li class="toclevel-2"><a href="#Easy_Maintenance"><span class="tocnumber">9.4</span> <span class="toctext">Easy Maintenance</span></a></li>
<li class="toclevel-2"><a href="#Fail-over_Scenarios"><span class="tocnumber">9.5</span> <span class="toctext">Fail-over Scenarios</span></a></li>
<li class="toclevel-2"><a href="#For_Testing"><span class="tocnumber">9.6</span> <span class="toctext">For Testing</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Performance_and_Stability"><span class="tocnumber">10</span> <span class="toctext">Performance and Stability</span></a>
<ul>
<li class="toclevel-2"><a href="#Impact_of_Linux-VServer_on_the_Host"><span class="tocnumber">10.1</span> <span class="toctext">Impact of Linux-VServer on the Host</span></a></li>
<li class="toclevel-2"><a href="#Overhead_inside_a_Context"><span class="tocnumber">10.2</span> <span class="toctext">Overhead inside a Context</span></a></li>
<li class="toclevel-2"><a href="#Size_of_the_Kernel_Patch"><span class="tocnumber">10.3</span> <span class="toctext">Size of the Kernel Patch</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Non_Intel_i386_Hardware"><span class="tocnumber">11</span> <span class="toctext">Non Intel i386 Hardware</span></a></li>
<li class="toclevel-1"><a href="#Linux_Kernel_Intro"><span class="tocnumber">12</span> <span class="toctext">Linux Kernel Intro</span></a>
<ul>
<li class="toclevel-2"><a href="#Kernel_and_User_Space"><span class="tocnumber">12.1</span> <span class="toctext">Kernel and User Space</span></a></li>
<li class="toclevel-2"><a href="#Linux_Syscalls"><span class="tocnumber">12.2</span> <span class="toctext">Linux Syscalls</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Kernel_Side_Implementation"><span class="tocnumber">13</span> <span class="toctext">Kernel Side Implementation</span></a>
<ul>
<li class="toclevel-2"><a href="#The_Syscall_Command_Switch"><span class="tocnumber">13.1</span> <span class="toctext">The Syscall Command Switch</span></a></li>
<li class="toclevel-2"><a href="#Utilized_Data_Structures"><span class="tocnumber">13.2</span> <span class="toctext">Utilized Data Structures</span></a>
<ul>
<li class="toclevel-3"><a href="#The_Context_Data_Structure"><span class="tocnumber">13.2.1</span> <span class="toctext">The Context Data Structure</span></a></li>
<li class="toclevel-3"><a href="#The_Scheduler_Command_Data"><span class="tocnumber">13.2.2</span> <span class="toctext">The Scheduler Command Data</span></a></li>
<li class="toclevel-3"><a href="#Example_Accounting:_Sockets"><span class="tocnumber">13.2.3</span> <span class="toctext">Example Accounting: Sockets</span></a></li>
<li class="toclevel-3"><a href="#Example_Limits:_Virtual_Memory"><span class="tocnumber">13.2.4</span> <span class="toctext">Example Limits: Virtual Memory</span></a></li>
<li class="toclevel-3"><a href="#Example_Virtualization:_Uptime"><span class="tocnumber">13.2.5</span> <span class="toctext">Example Virtualization: Uptime</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Abstract" id="Abstract"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=1" title="Edit section: Abstract">edit</a>]</span> <span class="mw-headline"> Abstract </span></h2>
<p>A soft partitioning concept based on <i>Security Contexts</i> which permits the creation of many independent Virtual Private Servers (VPS) that run simultaneously on a single physical server at full speed, efficiently sharing hardware resources.
</p><p>A VPS provides an almost identical operating environment as a conventional Linux Server. All services, such as ssh, mail, Web and databases, can be started on such a VPS, without (or in special cases with only minimal) modification, just like on any real server.
</p><p>Each virtual server has its own user account database and root password and is isolated from other virtual servers, except for the fact that they share the same hardware resources.
</p>
<a name="Introduction" id="Introduction"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=2" title="Edit section: Introduction">edit</a>]</span> <span class="mw-headline"> Introduction </span></h2>
<p>Over the years, computers have become sufficiently powerful to use virtualization to create the illusion of many smaller virtual machines, each running a separate operating system instance.
</p><p>There are several kinds of Virtual Machines (VMs) which provide similar features, but differ in the degree of abstraction and the methods used for virtualization.
</p><p>Most of them accomplish what they do by <i>emulating</i> some real or fictional hardware, which in turn requires <i>real</i> resources from the Host (the machine running the VMs). This approach, used by most System Emulators (like QEMU, Bochs, ...), allows the emulator to run an arbitrary Guest Operating System, even for a different Architecture (CPU and Hardware). No modifications need to be made to the Guest OS because it isn't aware of the fact that it isn't running on real hardware.
</p><p>Some System Emulators require small modifications or specialized drivers to be added to Host or Guest to improve performance and minimize the overhead required for the hardware emulation. Although this significantly improves efficiency, there are still large amounts of resources being wasted in caches and mediation between Guest and Host (examples for this approach are UML and Xen).
</p><p>But suppose you do not want to run many different Operating Systems simultaneously on a single box? Most applications running on a server do not require hardware access or kernel level code, and could easily share a machine with others, if they could be separated and secured...
</p>
<a name="The_Concept" id="The_Concept"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=3" title="Edit section: The Concept">edit</a>]</span> <span class="mw-headline"> The Concept </span></h2>
<p>At a basic level, a Linux Server consists of three building blocks: Hardware, Kernel and Applications. The Hardware usually depends on the provider or system maintainer, and, while it has a big influence on the overall performance, it cannot be changed that easily, and will likely differ from one setup to another.
</p><p>The main purpose of the Kernel is to build an abstraction layer on top of the hardware to allow processes (Applications) to work with and operate on resources (Data) without knowing the details of the underlying hardware. Ideally, those processes would be completely hardware agnostic, by being written in an interpreted language and therefore not requiring any hardware-specific knowledge.
</p><p>Given that a system has enough resources to drive ten times the number of applications a single Linux server would usually require, why not put ten servers on that box, which will then share the available resources in an efficient manner?
</p><p>Most server applications (e.g. httpd) will assume that it is the only application providing a particular service, and usually will also assume a certain filesystem layout and environment. This dictates that similar or identical services running on the same physical server, but for example, only differing in their addresses, have to be coordinated. This typically requires a great deal of administrative work which can lead to reduced system stability and security.
</p><p>The basic concept of the Linux-VServer solution is to separate the user-space environment into distinct units (sometimes called Virtual Private Servers) in such a way that each VPS looks and feels like a real server to the processes contained within.
</p><p>Although different Linux Distributions use (sometimes heavily) patched kernels to provide special support for unusual hardware or extra functionality, most Linux Distributions are not tied to a special kernel.
</p><p>Linux-VServer uses this fact to allow several distributions, to be run simultaneously on a single, shared kernel, without direct access to the hardware, and share the resources in a very efficient way.
</p>
<a name="Existing_Infrastructure" id="Existing_Infrastructure"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=4" title="Edit section: Existing Infrastructure">edit</a>]</span> <span class="mw-headline"> Existing Infrastructure </span></h2>
<p>Recent Linux Kernels already provide many security features that are utilized by Linux-VServer to do its work. Especially features such as the Linux Capability System, Resource Limits, File Attributes and the Change Root Environment. The following sections will give a short overview about each of these.
</p>
<a name="Linux_Capability_System" id="Linux_Capability_System"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=5" title="Edit section: Linux Capability System">edit</a>]</span> <span class="mw-headline"> Linux Capability System </span></h3>
<p>In computer science, a capability is a token used by a process to prove that it is allowed to perform an operation on an object. The Linux Capability System is based on "POSIX Capabilities", a somewhat different concept, designed to split up the all powerful root privilege into a set of distinct privileges.
</p>
<a name="POSIX_Capabilities" id="POSIX_Capabilities"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=6" title="Edit section: POSIX Capabilities">edit</a>]</span> <span class="mw-headline"> POSIX Capabilities </span></h4>
<p>A process has three sets of bitmaps called the inheritable(I), permitted(P), and effective(E) capabilities. Each capability is implemented as a bit in each of these bitmaps that is either set or unset.
</p><p>When a process tries to do a privileged operation, the operating system will check the appropriate bit in the effective set of the process (instead of checking whether the effective uid of the process is 0 as is normally done).
</p><p>For example, when a process tries to set the clock, the Linux kernel will check that the process has the CAP_SYS_TIME bit (which is currently bit 25) set in its effective set.
</p><p>The permitted set of the process indicates the capabilities the process can use. The process can have capabilities set in the permitted set that are not in the effective set.
</p><p>This indicates that the process has temporarily disabled this capability. A process is allowed to set a bit in its effective set only if it is available in the permitted set. The distinction between effective and permitted exists so that processes can "bracket" operations that need privilege.
</p><p>The inheritable capabilities are the capabilities of the current process that should be inherited by a program executed by the current process. The permitted set of a process is masked against the inheritable set during exec(). Nothing special happens during fork() or clone(). Child processes and threads are given an exact copy of the capabilities of the parent process.
</p><p>The implementation in Linux stopped at this point, whereas POSIX Capabilities[U5] requires the addition of capability sets to files too, to replace the SUID flag (at least for executables). The pending Linux 2.6.24 kernel supports file POSIX capabilities. (See Serge Hallyn's <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=b53767719b6cd8789392ea3e7e2eb7b8906898f0" class="external text" title="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=b53767719b6cd8789392ea3e7e2eb7b8906898f0" rel="nofollow">git commit</a> of Wed, 17 Oct 2007.) One userspace tool capable of changing file capabilities is the 2.X version of Andrew Morgan's <a href="http://kernel.org/pub/linux/libs/security/linux-privs/" class="external text" title="http://kernel.org/pub/linux/libs/security/linux-privs/" rel="nofollow">libcap</a> library and programs.
</p>
<a name="Capability_Overview" id="Capability_Overview"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=7" title="Edit section: Capability Overview">edit</a>]</span> <span class="mw-headline"> Capability Overview </span></h4>
<p>The list of POSIX Capabilities used with Linux is long, and the 32 available bits are almost used up. While the detailed list of all capabilities can be found in /usr/include/linux/capability.h on most Linux systems, an overview of important capabilities is given here.
</p>
<table class="wikitablenowrap">
<tr>
<th> [0] CAP_CHOWN
</th><td> change file ownership and group.
</td></tr>
<tr>
<th> [5] CAP_KILL
</th><td> send a signal to a process with a different real or effective user ID
</td></tr>
<tr>
<th> [6] CAP_SETGID
</th><td> permit setgid(2), setgroups(2), and forged gids on socket credentials passing
</td></tr>
<tr>
<th> [7] CAP_SETUID
</th><td> permit set*uid(2), and forged uids on socket credentials passing
</td></tr>
<tr>
<th> [8] CAP_SETPCAP
</th><td> transfer/remove any capability in permitted set to/from any pid
</td></tr>
<tr>
<th> [9] CAP_LINUX_IMMUTABLE
</th><td> allow modification of S_IMMUTABLE and S_APPEND file attributes
</td></tr>
<tr>
<th> [11] CAP_NET_BROADCAST
</th><td> permit broadcasting and listening to multicast
</td></tr>
<tr>
<th> [12] CAP_NET_ADMIN
</th><td> permit interface configuration, IP firewall, masquerading, accounting, socket debugging, routing tables, bind to any address, enter promiscuous mode, multicasting, ...
</td></tr>
<tr>
<th> [13] CAP_NET_RAW
</th><td> permit usage of RAW and PACKET sockets
</td></tr>
<tr>
<th> [16] CAP_SYS_MODULE
</th><td> insert and remove kernel modules
</td></tr>
<tr>
<th> [18] CAP_SYS_CHROOT
</th><td> permit chroot(2)
</td></tr>
<tr>
<th> [19] CAP_SYS_PTRACE
</th><td> permit ptrace() of any process
</td></tr>
<tr>
<th> [21] CAP_SYS_ADMIN
</th><td> this list would be too long, it basically allows to do everything else, not mentioned in another capability.
</td></tr>
<tr>
<th> [22] CAP_SYS_BOOT
</th><td> permit reboot(2)
</td></tr>
<tr>
<th> [23] CAP_SYS_NICE
</th><td> allow raising priority and setting priority on other processes, modify scheduling
</td></tr>
<tr>
<th> [24] CAP_SYS_RESOURCE
</th><td> override resource limits, quota, reserved space on fs, ...
</td></tr>
<tr>
<th> [27] CAP_MKNOD
</th><td> permit the privileged aspects of mknod(2)
</td></tr></table>
<a name="Resource_Limits" id="Resource_Limits"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=8" title="Edit section: Resource Limits">edit</a>]</span> <span class="mw-headline"> Resource Limits </span></h3>
<p>Resources for each process can be limited by specifying a Resource Limit. Similar to the Linux Capabilities, there are two different limits, a Soft Limit and a Hard Limit.
</p><p>The soft limit is the value that the kernel enforces for the corresponding resource. The hard limit acts as a ceiling for the soft limit: an unprivileged process may only set its soft limit to a value in the range from zero up to the hard limit, and (irreversibly) lower its hard limit. A privileged process may make arbitrary changes to either limit value, as long as the soft limit stays below the hard limit.
</p>
<a name="Limit-able_Resource_Overview" id="Limit-able_Resource_Overview"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=9" title="Edit section: Limit-able Resource Overview">edit</a>]</span> <span class="mw-headline"> Limit-able Resource Overview </span></h4>
<p>The list of all defined resource limits can be found in /usr/include/asm/resource.h on most Linux systems, an overview of relevant resource limits is given here.
</p>
<table class="wikitablenowrap">

<tr>
<th> [0] RLIMIT_CPU
</th><td> CPU time in seconds. process is sent a SIGXCPU signal after reaching the soft limit, and SIGKILL on hard limit.
</td></tr>
<tr>
<th> [4] RLIMIT_CORE
</th><td> maximum size of core files generated
</td></tr>
<tr>
<th> [5] RLIMIT_RSS
</th><td> number of pages the process's resident set can consume (the number of virtual pages resident in RAM)
</td></tr>
<tr>
<th> [6] RLIMIT_NPROC
</th><td> The maximum number of processes that can be created for the real user ID of the calling process.
</td></tr>
<tr>
<th> [7] RLIMIT_NOFILE
</th><td> Specifies a value one greater than the maximum file descriptor number that can be opened by this process.
</td></tr>
<tr>
<th> [8] RLIMIT_MEMLOCK
</th><td> The maximum number of virtual memory pages that may be locked into RAM using mlock() and mlockall().
</td></tr>
<tr>
<th> [9] RLIMIT_AS
</th><td> The maximum number of virtual memory pages available to the process (address space limit). \
</td></tr></table>
<a name="File_Attributes" id="File_Attributes"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=10" title="Edit section: File Attributes">edit</a>]</span> <span class="mw-headline"> File Attributes </span></h3>
<p>Originally, this feature was only available with ext2, but now all major filesystems implement a basic set of File Attributes that permit certain properties to be changed. Here again is a short overview of the possible attributes, and what they mean.
</p>
<table class="wikitablenowrap">
<tr>
<th>
</th><th> Macro Name
</th><th> Meaning
</th></tr>
<tr>
<th> s
</th><th> SECRM
</th><td> When a file with this attribute set is deleted, its blocks are zeroed and written back to the disk.
</td></tr>
<tr>
<th> u
</th><th> UNRM
</th><td> When a file with this attribute set is deleted, its contents are saved.
</td></tr>
<tr>
<th> c
</th><th> COMPR
</th><td> Files marked with this attribute are automatically compressed on write and uncompressed on read. (not implemented yet)
</td></tr>
<tr>
<th> i
</th><th> IMMUTABLE
</th><td> A file with this attribute cannot be modified: it cannot be deleted or renamed, no link can be created to this file and no data can be written to the file.
</td></tr>
<tr>
<th> a
</th><th> APPEND
</th><td> Files with this attribute set can only be opened in append mode for writing.
</td></tr>
<tr>
<th> d
</th><th> NODUMP
</th><td> If this flag is set, the file is not candidate for backup with the dump utility.
</td></tr>
<tr>
<th> S
</th><th> SYNC
</th><td> Updates to the file contents are done synchronously.
</td></tr>
<tr>
<th> A
</th><th> NOATIME
</th><td> Prevents updating the atime record on files when they are accessed or modified.
</td></tr>
<tr>
<th> t
</th><th> NOTAIL
</th><td> A file with the t attribute will not have a partial block fragment at the end of the file merged with other files.
</td></tr>
<tr>
<th> D
</th><th> DIRSYNC
</th><td> Changes to a directory having this attribute set will be done synchronously.
</td></tr></table>
<p>The first column in the above table denotes command line options one might supply to <i>lsattr</i> respectively <i>chattr</i>. The below screedump gives a notion about what we are talking:
</p>
<pre>
max@pc1:~$ cd /tmp/
max@pc1:/tmp$ touch my_file
max@pc1:/tmp$ lsattr my_file
------------------ my_file
max@pc1:/tmp$ chattr +a my_file
chattr: Operation not permitted while setting flags on my_file
max@pc1:/tmp$ su
Password:
pc1:/tmp# chattr +a my_file &amp;&amp; lsattr my_file
-----a------------ my_file
pc1:/tmp# exit
exit
max@pc1:/tmp$
</pre>
<p>As you might have noticed, one needs to gain root permissions in the upper showcase (the underlying file system was ext3). For more information just issue <i>man 1 chattr</i> in your command line interface.
</p><p><br />
Information regarding file attributes can be found in the kernel source code. Every file system uses a subset of all known attributes (which are used depends on the file system). 
</p><p>One thing can be said for sure -- the file attributes listed in the kernel source code are defined -- those are not listed are not defined and in turn can not be used for a particular file system (e.g. ext3 (Extended File System version 3)). However, many of those file attributes defined and understood by the kernel have no effect. Most file systems define those flags in a specific (specific for a particular file system) header file found within the kernel source tree. They also define a so called <b>User Modifiable Mask</b> (those are the flags the user can change with the <i>ioctls</i>).
</p><p>Those flags have partially different meaning depending on the node type (i.e. dir, inode, fifo, pipe, device) and it is not trivial to say if a filesystem makes use of any user modifiable flag -- things like immutable are easy to verify (from user space) but how to verify e.g. NOTAIL from user space? Usually only source code review will show if it is implemented and used.
</p><p>For example, if that didn't change, the COMPR is defined, and well understood by ext2/3 but there is no implementation there, i.e. nothing is compressed.
</p>
<a name="The_chroot.281.29_Command" id="The_chroot.281.29_Command"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=11" title="Edit section: The chroot(1) Command">edit</a>]</span> <span class="mw-headline"> The chroot(1) Command </span></h3>
<p>chroot allows you to run a command with a different directory acting as the root directory. This means that all filesystem lookups are done with '/' referring to the substitute root directory and not to the original one.
</p><p>While the Linux chroot implementation isn't very secure, it increases the isolation of processes with regards to the filesystem, and, if used properly, can create a filesystem "jail" for a single process or a restricted user, daemon or service.
</p>
<a name="Required_Modifications" id="Required_Modifications"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=12" title="Edit section: Required Modifications">edit</a>]</span> <span class="mw-headline"> Required Modifications </span></h2>
<p>This chapter will describe the essential Kernel modifications to implement something like Linux-VServer.
</p>
<a name="Context_Separation" id="Context_Separation"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=13" title="Edit section: Context Separation">edit</a>]</span> <span class="mw-headline"> Context Separation </span></h3>
<p>The separation mentioned in the Concepts section requires some modifications to the kernel to allow for the notion of Contexts.
The purpose of this "Context" is to hide all processes outside of its scope, and prohibit any unwanted interaction between a process inside the context and a process belonging to another context.
</p><p>This separation requires the extension of some existing data structures in order for them to become aware of contexts and to differentiate between identical uids used in different virtual servers.
</p><p>It also requires the definition of a default context that is used when the host system is booted, and to work around the issues resulting from some false assumptions made by some user-space tools (like pstree) that the init process has to exist and to be running under id '1'.
</p><p>To simplify administration, the Host Context isn't treated any differently than any other context as far as process isolation is concerned. To allow for process overview, a special Spectator context has been defined to peek at all processes at once.
</p>
<a name="Network_Separation" id="Network_Separation"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=14" title="Edit section: Network Separation">edit</a>]</span> <span class="mw-headline"> Network Separation </span></h3>
<p>While the Context Separation is sufficient to isolate groups of processes, a different kind of separation, or rather a limitation, is required to confine processes to a subset of available network addresses.
</p><p>Several issues have to be considered when doing so; for example, the fact that bindings to special addresses like IPADDR_ANY or the local host address have to be handled in a very special way.
</p><p>Currently, Linux-VServer doesn't make use of virtual network devices (and maybe never will) to minimize the resulting overhead. Therefore socket binding and packet transmission have been adjusted.
</p>
<a name="The_Chroot_Barrier" id="The_Chroot_Barrier"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=15" title="Edit section: The Chroot Barrier">edit</a>]</span> <span class="mw-headline"> The Chroot Barrier </span></h3>
<p>One major problem of the chroot() system used in Linux lies within the fact that this information is volatile, and will be changed on the next chroot() Syscall.
</p><p>One simple method to escape from a chroot-ed environment is as follows: First, create or open a file and retain the file-descriptor, then chroot into a subdirectory at equal or lower level with regards to the file. This causes the root to be moved down in the filesystem. Next, use fchdir() on the file-descriptor to escape from that new root. This will consequently escape from the old root as well, as this was lost in the last chroot() Syscall.
</p><p>While early Linux-VServer versions tried to fix this by "funny" methods, recent versions use a special marking, known as the Chroot Barrier, on the parent directory of each VPS to prevent unauthorized modification and escape from confinement.
</p>
<a name="Upper_Bound_for_Caps" id="Upper_Bound_for_Caps"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=16" title="Edit section: Upper Bound for Caps">edit</a>]</span> <span class="mw-headline"> Upper Bound for Caps </span></h3>
<p>Because the current Linux Capability system does not implement the filesystem related portions of POSIX Capabilities which would make setuid and setgid executables secure, and because it is much safer to have a secure upper bound for all processes within a context, an additional per-context capability mask has been added to limit all processes belonging to that context to this mask.
</p><p>The meaning of the individual caps (bits) of the capability bound mask is exactly the same as with the permitted capability set.
</p>
<a name="Resource_Isolation" id="Resource_Isolation"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=17" title="Edit section: Resource Isolation">edit</a>]</span> <span class="mw-headline"> Resource Isolation </span></h3>
<p>Most resources are somewhat shared among the different contexts. Some require more additional isolation than others, either to avoid security issues or to allow for improved accounting.
</p><p>Those resources are:
</p>
<ul><li> shared memory, IPC
</li><li> user and process IDs
</li><li> file xid tagging
</li><li> Unix ptys
</li><li> sockets
</li></ul>
<a name="Filesystem_XID_Tagging" id="Filesystem_XID_Tagging"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=18" title="Edit section: Filesystem XID Tagging">edit</a>]</span> <span class="mw-headline"> Filesystem XID Tagging </span></h3>
<p>Although it can be disabled completely, this modification is required for more robust filesystem level security and context isolation. It is also mandatory for Context Disk Limits and Per Context Quota Support on a shared partition.
</p><p>The concept of adding a context id (xid) to each file to make the context ownership persistent sounds simple, but the actual implementation is non-trivial - mainly because adding this information either requires a change to the on disk representation of the filesystem or the application of some tricks.
</p><p>One non-intrusive approach to avoid modification of the underlying filesystem is to use the upper bits of existing fields, like those for UID and GID to store the additional XID.
</p><p>Once context information is available for each inode, it is a logical step to extend the access controls to check against context too.
Currently all inode access restrictions have been extended to check for the context id, with special exceptions for the Host Context and the Spectator Context.
</p><p>Untagged files belong to the Host Context and are silently treated as if they belong to the current context, which is required for Unification. If such a file is modified from inside a context, it silently migrates to the new one, changing its xid.
</p><p>The following Tagging Methods are implemented:
</p>
<table class="wikitablenowrap">
<tr>
<th> UID32/GID32 or EXTERNAL
</th><td> This format uses currently unused space within the disk inode to store the context information. As of now, this is only defined for ext2/ext3 but will be also defined for xfs, reiserfs, and jfs as soon as possible. Advantage: Full 32bit uid/gid values.
</td></tr>
<tr>
<th> UID32/GID16
</th><td> This format uses the upper half of the group id to store the context information. This is done transparently, except if the format is changed without prior file conversion. Advantage: works on all 32bit U/GID FSs. Drawback: GID is reduced to 16 bits.
</td></tr>
<tr>
<th> UID24/GID24
</th><td> This format uses the upper quarter of user and group id to store the context information, again transparently. This allows for about 16 million user and group ids, which should suffice for the majority of all applications. Advantage: works on all 32bit U/GID FSs. Drawback: UID and GID are reduced to 24 bits.
</td></tr></table>
<a name="Additional_Modifications" id="Additional_Modifications"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=19" title="Edit section: Additional Modifications">edit</a>]</span> <span class="mw-headline"> Additional Modifications </span></h2>
<p>In addition to the bare minimum, there are a number of modifications that are not mandatory, but have proven extremely useful over time.
</p>
<a name="Context_Flags" id="Context_Flags"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=20" title="Edit section: Context Flags">edit</a>]</span> <span class="mw-headline"> Context Flags </span></h3>
<p>It was very soon discovered that some features require a flag, a kind of switch to turn them on and off separately for each Linux-VServer, so a simple flag-word was added.
</p><p>This flag-word supports quite a number of flags, a flag-word mask, which allows to tell what flags are available, and a special trigger mechanism, providing one-time flags, set on startup, that can only be cleared once, usually causing a special action or event.
</p><p>Here is a list of planned and mostly implemented Context Flags, available in the development branch of Linux-VServer:
</p>
<table class="wikitablenowrap">
<tr>
<th> [0] VXF_INFO_LOCK
</th><td> (legacy, obsoleted)
</td></tr>
<tr>
<th> [1] VXF_INFO_SCHED
</th><td> schedule all processes in a context as if they where one. (legacy, obsoleted)
</td></tr>
<tr>
<th> [2] VXF_INFO_NPROC
</th><td> limit the number of processes in a context to the initial NPROC value. (legacy, obsoleted)
</td></tr>
<tr>
<th> [3] VXF_INFO_PRIVATE
</th><td> do not allow to join this context from outside. (legacy)
</td></tr>
<tr>
<th> [4] VXF_INFO_INIT
</th><td> show the init process with pid '1' (legacy)
</td></tr>
<tr>
<th> [5] VXF_INFO_HIDE
</th><td> (legacy, obsoleted)
</td></tr>
<tr>
<th> [6] VXF_INFO_ULIMIT
</th><td> (legacy, obsoleted)
</td></tr>
<tr>
<th> [7] VXF_INFO_NSPACE
</th><td> (legacy, obsoleted)
</td></tr>
<tr>
<th> [8] VXF_SCHED_HARD
</th><td> activate the Hard CPU scheduling
</td></tr>
<tr>
<th> [9] VXF_SCHED_PRIO
</th><td> use the context token bucket for calculating the process priorities
</td></tr>
<tr>
<th> [10] VXF_SCHED_PAUSE
</th><td> put all processes in this context on the hold queue, not scheduling them any longer
</td></tr>
<tr>
<th> [16] VXF_VIRT_MEM
</th><td> virtualize the memory information so that the VM and RSS limits are used for meminfo and friends
</td></tr>
<tr>
<th> [17] VXF_VIRT_UPTIME
</th><td> virtualize the uptime, beginning with the time of context creation
</td></tr>
<tr>
<th> [18] VXF_VIRT_CPU
</th><td>
</td></tr>
<tr>
<th> [24] VXF_HIDE_MOUNT
</th><td> show empty proc/{pid}/mounts
</td></tr>
<tr>
<th> [25] VXF_HIDE_NETIF
</th><td> hide network interfaces and addresses not permitted by the network context
</td></tr></table>
<a name="Context_Capabilities" id="Context_Capabilities"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=21" title="Edit section: Context Capabilities">edit</a>]</span> <span class="mw-headline"> Context Capabilities </span></h3>
<p>As the Linux Capabilities have almost reached the maximum number that is possible without heavy modifications to the kernel, it was a natural step to add a context-specific capability system.
</p><p>The Linux-VServer context capability set acts as a mechanism to fine tune existing Linux capabilities. It is not visible to the processes within a context, as they would not know how to modify or verify it.
</p><p>In general there are two ways to use those capabilities:
</p>
<ul><li> Require one or a number of context capabilities to be set in addition to a given Linux capability, each one controlling a distinct part of the functionality.For example the CAP_NET_ADMIN could be split into RAW and PACKET sockets, so you could take away each of them separately by not providing the required context capability.
</li></ul>
<ul><li> Consider the context capability sufficient for a specified functionality, even if the Linux Capability says something different.For example mount() requires CAP_SYS_ADMIN which adds a dozen other things we do not want, so we define a CCAP_MOUNT to allow mounts for certain contexts.
</li></ul>
<p>The difference between the Context Flags and the Context Caps is more an abstract logical separation than a functional one, because they are handled very similarly.
</p><p>Again, a list of the Context Capabilities and their purpose:
</p><p><br />
</p>
<table class="wikitablenowrap">
<tr>
<th> [0] VXC_SET_UTSNAME
</th><td> allow the context to change the host and domain name with the appropriate kernel Syscall
</td></tr>
<tr>
<th> [1] VXC_SET_RLIMIT
</th><td> allow the context to modify the resource limits (within the vserver limits).
</td></tr>
<tr>
<th> [8] VXC_RAW_ICMP
</th><td> allow raw icmp packets in a secure way (this makes ping work from inside)
</td></tr>
<tr>
<th> [16] VXC_SECURE_MOUNT
</th><td> permit secure mounts, which at the moment means that the nodev mount option is added.
</td></tr></table>
<a name="Context_Accounting" id="Context_Accounting"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=22" title="Edit section: Context Accounting">edit</a>]</span> <span class="mw-headline"> Context Accounting </span></h3>
<p>Some properties of a context are useful to the admin, either for keeping an overview of the resources, to get a feeling for the capacity of the host, or for billing them in some way to a customer.
</p><p>There are two different kinds of accountable properties, those having a current value which represents the state of the system (for example the speed of a vehicle), and those which monotonically increase over time (like the mileage).
</p><p>Most of the state type of properties also qualify for applying some limits, so they are handled specially. this is described in more detail in the following section.
</p><p>Good candidates for Context Accounting are:
</p>
<ul><li> Amount of CPU Time spent
</li><li> Number of Forks done
</li><li> Socket Messages by Type
</li><li> Network Packets Transmitted and Received
</li></ul>
<a name="Context_Limits" id="Context_Limits"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=23" title="Edit section: Context Limits">edit</a>]</span> <span class="mw-headline"> Context Limits </span></h3>
<p>Most properties related to system resources, might it be the memory consumption, the number of processes or file-handles, or the current network bandwidth, qualify for imposing limits on them.
</p><p>To provide a general framework for all kinds of limits, Context Limits allow the configuration of three different values for each limit-able resource: the minimum, a soft limit and a hard limit (maximum).
</p><p>At the time this is written, only the hard limits are supported and not all of them are actually enforced, but here is a list of current and planned Context Limits:
</p>
<ul><li> process limits
</li><li> scheduler limits
</li><li> memory limits
</li><li> per-context disk limits
</li><li> per-context user/group quota
</li></ul>
<p>Additionally the context limit system keeps track of observed maxima and resource limit hits, to provide some feedback for the administrator.
</p>
<a name="Virtualization" id="Virtualization"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=24" title="Edit section: Virtualization">edit</a>]</span> <span class="mw-headline"> Virtualization </span></h3>
<p>One major difference between the Linux-VServer approach and Virtual Machines is that you do not have the virtualization part as a side-effect, so you have to do that by hand where it makes sense.
</p><p>For example, a Virtual Machine does not need to think about uptime, because naturally the running OS was started somewhere in the past and will not have any problem to tell the time it thinks it began running.
</p><p>A context can also store the time when it was created, but that will be different from the systems uptime, so in addition, there has to be some function, which adjusts the values passed from kernel to user-space depending on the context the process belongs to.
</p><p>This is what for Linux-VServer is known as Virtualization (actually it's more faking some values passed to and from the kernel to make the processes think that they are on a different machine).
</p><p>Currently modified for the purpose of Virtualization are:
</p>
<ul><li> System Uptime
</li><li> Host and Domain Name
</li><li> Machine Type and Kernel Version
</li><li> Context Memory Availability
</li><li> Context Disk Space
</li></ul>
<a name="Improved_Security" id="Improved_Security"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=25" title="Edit section: Improved Security">edit</a>]</span> <span class="mw-headline"> Improved Security </span></h3>
<p>Proc-FS Security provides a mechanism to protect dynamic entries in the proc filesystem from being seen in every context.
The system consists of three flags for each Proc-FS entry: Admin, Watch and Hide.
</p><p>The Hide flag enables or disables the entire feature, so any combination with the Hide flag cleared will mean total visibility.
The Admin and Watch flags determine where the hidden entry remains visible; so for example if Admin and Hidden are set, the Host Context will be the only one able to see this specific entry.
</p>
<a name="Kernel_Helper" id="Kernel_Helper"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=26" title="Edit section: Kernel Helper">edit</a>]</span> <span class="mw-headline"> Kernel Helper </span></h3>
<p>For some purposes, it makes sense to have an user-space tool to act on behalf of the kernel, when a process inside a context requests something usually available on a real server, but naturally not available inside a context.
</p><p>The best, and currently only example for this is the Reboot Helper, which handles the reboot() system call, invoked from inside a context on behalf of the Kernel. It is executed, in Host side user-space to take appropriate actions - either reboot or just shutdown (halt) the specified context.
</p><p>While the helper is designed to be flexible and handle different things in a similar way there are no other users of this helper at the moment. It might be replaced by an event interface in near future.
</p>
<a name="Features_and_Bonus_Material" id="Features_and_Bonus_Material"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=27" title="Edit section: Features and Bonus Material">edit</a>]</span> <span class="mw-headline"> Features and Bonus Material </span></h2>
<a name="Unification" id="Unification"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=28" title="Edit section: Unification">edit</a>]</span> <span class="mw-headline"> Unification </span></h3>
<p>Because one of the central objectives for Linux-VServer is to reduce the overall resource usage wherever possible, a truly great idea was born to share files between different contexts without interfering with the usual administrative tasks or reducing the level of security created by the isolation.
</p><p>Files common to more than one context, which are not very likely going to change, like libraries or binaries, can be hard linked on a shared filesystem, thus reducing the amount of disk space, inode caches, and even memory mappings for shared libraries.
</p><p>The only drawback is that without additional measures, a malicious context would be able to deliberately or accidentally destroy or modify such shared files, which in turn would harm the other contexts.
</p><p>One step is to make the shared files immutable by using the Immutable File Attribute (and removing the Linux Capability required to modify this attribute). However an additional attribute is required to allow removal of such immutable shared files, to allow for updates of libraries or executables from inside a context.
</p><p>Such hard linked, immutable but unlink-able files belonging to more than one context are called unified and the process of finding common files and preparing them in this way is called Unification.
</p><p>The reason for doing this is reduced resource consumption, not simplified administration. While a typical Linux Server install will consume about 500MB of disk space, 10 unified servers will only need about 700MB and as a bonus use less memory for caching.
</p>
<a name="Private_Namespaces" id="Private_Namespaces"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=29" title="Edit section: Private Namespaces">edit</a>]</span> <span class="mw-headline"> Private Namespaces </span></h3>
<p>A recent addition to the Linux-VServer branch was the introduction of Private Namespaces. This uses the already existing Virtual Filesystem Layer of the Linux kernel to create a separate view of the filesystem for the processes belonging to a context.
</p><p>The major advantage over the shared namespace used by default is that any modifications to the namespace layout (like mounts) do not affect other contexts, not even the Host Context.
</p><p>Obviously the drawback of that approach is that entering such a Private Namespace isn't as trivial as changing the root directory, but with proper kernel support this will completely replace the chroot() in the future.
</p>
<a name="The_Linux-VServer_Proc-FS" id="The_Linux-VServer_Proc-FS"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=30" title="Edit section: The Linux-VServer Proc-FS">edit</a>]</span> <span class="mw-headline"> The Linux-VServer Proc-FS </span></h3>
<p>A structured, dynamically generated subtree of the well-known Proc-FS - actually two of them - has been created to allow for inspecting the different values of Security and Network Contexts.
</p>
<pre>
/proc/virtual
  .../info

/proc/virtual/&lt;pid&gt;
  .../info
  .../status
  .../sched
  .../cvirt
  .../cacct
  .../limit
</pre>
<a name="Token_Bucket_Extensions" id="Token_Bucket_Extensions"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=31" title="Edit section: Token Bucket Extensions">edit</a>]</span> <span class="mw-headline"> Token Bucket Extensions </span></h3>
<p>While the basic idea of Linux-VServer is a peaceful coexistence of all contexts, sharing the common resources in a respectful way, it is sometimes useful to control the resource distribution for resource hungry processes.
</p><p>The basic principle of a Token Bucket is not very new. It is given here as an example for the Hard CPU Limit. The same principle also applies to scheduler priorities, network bandwidth limitation and resource control in general.
</p><p>The Hard CPU Limit uses this mechanism in the following way: consider a bucket of a certain size S which is filled with a specified amount of tokens R every interval T, until the bucket is "full" - excess tokens are spilled. At each timer tick, a running process consumes exactly one token from the bucket, unless the bucket is empty, in which case the process is put on a hold queue until the bucket has been refilled with a minimum M of tokens. The process is then rescheduled.
</p><p>A major advantage of a Token Bucket is that a certain amount of tokens can be accumulated in times of quiescence, which later can be used to burst when resources are required.
</p><p>Where a per-process Token Bucket would allow for a CPU resource limitation of a single process, a Context Token Bucket allows to control the CPU usage of all confined processes.
</p><p>Another approach, which is also implemented, is to use the current fill level of the bucket to adjust the process priority, thus reducing the priority of processes belonging to excessive contexts.
</p>
<a name="Context_Disk_Limits" id="Context_Disk_Limits"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=32" title="Edit section: Context Disk Limits">edit</a>]</span> <span class="mw-headline"> Context Disk Limits </span></h3>
<p>This Feature requires the use of XID Tagged Files, and allows for independent Disk Limits for different contexts on a shared partition.
The number of inodes and blocks for each filesystem is accounted, if an XID-Hash was added for the Context-Filesystem combo.
</p><p>Those values, including current usage, maximum and reserved space, will be shown for filesystem queries, creating the illusion that the shared filesystem has a different usage and size, for each context.
</p>
<a name="Per-Context_Quota" id="Per-Context_Quota"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=33" title="Edit section: Per-Context Quota">edit</a>]</span> <span class="mw-headline"> Per-Context Quota </span></h3>
<p>Similar to the Context Disk Limits, Per-Context Quota uses separate quota hashes for different Contexts on a shared filesystem. This is not required to allow for Linux-VServer quota on separate partitions.
</p>
<a name="The_VRoot_Proxy_Device" id="The_VRoot_Proxy_Device"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=34" title="Edit section: The VRoot Proxy Device">edit</a>]</span> <span class="mw-headline"> The VRoot Proxy Device </span></h3>
<p>Quota operations (ioctls) require some access to the block device, which for security reasons is not available inside a VPS.
</p>
<a name="Stealth" id="Stealth"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=35" title="Edit section: Stealth">edit</a>]</span> <span class="mw-headline"> Stealth </span></h3>
<p>For some applications, for example the preparation of a honey-pot or an especially realistic imitation of a real server for educational purposes, it can make sense to make the context indistinguishable from a real server.
</p><p>However, since other freely available alternatives like QEMU or UML are much better at this, and require much less effort, this is not a central issue in Linux-VServer development.
</p>
<a name="Linux-VServer_Security" id="Linux-VServer_Security"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=36" title="Edit section: Linux-VServer Security">edit</a>]</span> <span class="mw-headline"> Linux-VServer Security </span></h2>
<p>Now that we know what the Linux-VServer framework provides and how some features work, let's have a word on security, because you should not rely on the framework to be secure per definition. Instead, you should exactly know what you are doing.
</p>
<a name="Secure_Capabilities" id="Secure_Capabilities"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=37" title="Edit section: Secure Capabilities">edit</a>]</span> <span class="mw-headline"> Secure Capabilities </span></h3>
<p>Currently the following Linux Capabilities are considered secure for VPS use. If others are added, it will probably open some security hole.
</p>
<ul><li> CAP_CHOWN
</li><li> CAP_DAC_OVERRIDE
</li><li> CAP_DAC_READ_SEARCH
</li><li> CAP_FOWNER
</li><li> CAP_FSETID
</li><li> CAP_KILL
</li><li> CAP_SETGID
</li><li> CAP_SETUID
</li><li> CAP_NET_BIND_SERVICE
</li><li> CAP_SYS_CHROOT
</li><li> CAP_SYS_PTRACE
</li><li> CAP_SYS_BOOT
</li><li> CAP_SYS_TTY_CONFIG
</li><li> CAP_LEASE
</li></ul>
<p>CAP_NET_RAW for example is not considered secure although it is often used to allow the broken ping command to work, although there are better alternatives like the userspace ping command poink[U7] or the VXC_RAW_ICMP Context Capability.
</p>
<a name="The_Chroot_Barrier_2" id="The_Chroot_Barrier_2"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=38" title="Edit section: The Chroot Barrier">edit</a>]</span> <span class="mw-headline"> The Chroot Barrier </span></h3>
<p>Ensuring that the Barrier flag is set on the parent directory of each VPS is vital if you do not want VPS root to escape from the confinement and walk your Host's root filesystem.
</p>
<a name="Secure_Device_Nodes" id="Secure_Device_Nodes"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=39" title="Edit section: Secure Device Nodes">edit</a>]</span> <span class="mw-headline"> Secure Device Nodes </span></h3>
<p>The /dev directory of a VPS should not contain more than the following devices and the one directory for the unix pts tree.
</p>
<ul><li> c 1 7 full
</li><li> c 1 3 null
</li><li> c 5 2 ptmx
</li><li> c 1 8 random
</li><li> c 5 0 tty
</li><li> c 1 9 urandom
</li><li> c 1 5 zero
</li><li> d pts
</li></ul>
<p>Of course other device nodes like console, mem and kmem, even block and character devices can be added, but some expertise is required in order to ensure no security holes are opened.
</p>
<a name="Secure_Proc-FS_Entries" id="Secure_Proc-FS_Entries"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=40" title="Edit section: Secure Proc-FS Entries">edit</a>]</span> <span class="mw-headline"> Secure Proc-FS Entries </span></h3>
<p>There has been no detailed evaluation of secure and unsecure entries in the proc filesystem, but there have been some incidents where unprotected (not protected via Linux Capabilities) writable proc entries caused mayhem.
</p><p>For example, /proc/sysrq-trigger is something which should not be accessible inside a VPS without a very good reason.
</p>
<a name="Field_of_Application" id="Field_of_Application"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=41" title="Edit section: Field of Application">edit</a>]</span> <span class="mw-headline"> Field of Application </span></h2>
<p>The primary goal of this project is to create virtual servers sharing the same machine. A virtual server operates like a normal Linux server. It runs normal services such as telnet, mail servers, web servers, and SQL servers.
</p>
<a name="Administrative_Separation" id="Administrative_Separation"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=42" title="Edit section: Administrative Separation">edit</a>]</span> <span class="mw-headline"> Administrative Separation </span></h3>
<p>This allows a clever provider to sell something called Virtual Private Server, which uses less resources than other virtualization techniques, which in turn allows more units on a single machine.
</p><p>The list of providers doing so is relatively long, and so this is rightfully considered the main area of application.
</p>
<a name="Service_Separation" id="Service_Separation"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=43" title="Edit section: Service Separation">edit</a>]</span> <span class="mw-headline"> Service Separation </span></h3>
<p>Separating different or similar services which otherwise would interfere with each other, either because they are poorly designed or because they are simply incapable of peaceful coexistence for whatever reason, can be easily done with Linux-VServer.
</p><p>But even on the old-fashioned real server machines, putting some extremely exposed or untrusted, because unknown or proprietary, services into some kind of jail can improve maintainability and security a lot.
</p>
<a name="Enhancing_Security" id="Enhancing_Security"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=44" title="Edit section: Enhancing Security">edit</a>]</span> <span class="mw-headline"> Enhancing Security </span></h3>
<p>While it can be interesting to run several virtual servers in one box, there is one concept potentially more generally useful. Imagine a physical server running a single virtual server. The goal is isolate the main environment from any service, any network. You boot in the main environment, start very few services and then continue in the virtual server.
</p><p>The service in the main environment would be:
</p>
<ul><li> Unreachable from the network.
</li><li> Able to log messages from the virtual server in a secure way. The virtual server would be unable to change/erase the logs.\ Even a cracked virtual server would not be able the edit the log.
</li><li> Able to run intrusion detection facilities, potentially spying the state of the virtual server without being accessible or noticed.\ For example, tripwire could run there and it would be impossible to circumvent its operation or trick it.
</li></ul>
<p>Another option is to put the firewall in a virtual server, and pull in the DMZ, containing each service in a separate VPS. On proper configuration, this setup can reduce the number of required machines drastically, without impacting performance.
</p>
<a name="Easy_Maintenance" id="Easy_Maintenance"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=45" title="Edit section: Easy Maintenance">edit</a>]</span> <span class="mw-headline"> Easy Maintenance </span></h3>
<p>One key feature of a virtual server is the independence from the actual hardware. Most hardware issues are irrelevant for a virtual server installation.
</p><p>The main server acts as a host and takes care of all the details. The virtual server is just a client and ignores all the details. As such, the client can be moved to another physical server with very few manipulations.
</p><p>For example, to move the virtual server from one physical computer to another, it is sufficient to do the following:
</p>
<ul><li> shutdown the running server
</li><li> copy it over to the other machine
</li><li> copy the configuration
</li><li> start the virtual server on the new machine
</li></ul>
<p>No adjustments to user setup, password database or hardware configuration are required, as long as both machines are binary compatible.
</p>
<a name="Fail-over_Scenarios" id="Fail-over_Scenarios"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=46" title="Edit section: Fail-over Scenarios">edit</a>]</span> <span class="mw-headline"> Fail-over Scenarios </span></h3>
<p>Pushing the limit a little further, replication technology could be used to keep an up-to-the-minute copy of the filesystem of a running Virtual Server. This would permit a very fast fail-over if the running server goes offline for whatever reason.
</p><p>All the known methods to accomplish this, starting with network replication via rsync, or drbd, via network devices, or shared disk arrays, to distributed filesystems, can be utilized to reduce the down-time and improve overall efficiency.
</p>
<a name="For_Testing" id="For_Testing"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=47" title="Edit section: For Testing">edit</a>]</span> <span class="mw-headline"> For Testing </span></h3>
<p>Consider a software tool or package which should be built for several versions of a specific distribution (Mandrake 8.2, 9.0, 9.1, 9.2, 10.0) or even for different distributions.
</p><p>This is easily solved with Linux-VServer. Given plenty of disk space, the different distributions can be installed and running side by side, simplifying the task of switching from one to another.
</p><p>Of course this can be accomplished by chroot() alone, but with Linux-VServer it's a much more realistic simulation.
</p>
<a name="Performance_and_Stability" id="Performance_and_Stability"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=48" title="Edit section: Performance and Stability">edit</a>]</span> <span class="mw-headline"> Performance and Stability </span></h2>
<p><i>(work in progress)</i>
</p>
<a name="Impact_of_Linux-VServer_on_the_Host" id="Impact_of_Linux-VServer_on_the_Host"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=49" title="Edit section: Impact of Linux-VServer on the Host">edit</a>]</span> <span class="mw-headline"> Impact of Linux-VServer on the Host </span></h3>
<p>seems to be 0% ...
</p>
<a name="Overhead_inside_a_Context" id="Overhead_inside_a_Context"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=50" title="Edit section: Overhead inside a Context">edit</a>]</span> <span class="mw-headline"> Overhead inside a Context </span></h3>
<p>seems to be less than 2% ...
</p>
<a name="Size_of_the_Kernel_Patch" id="Size_of_the_Kernel_Patch"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=51" title="Edit section: Size of the Kernel Patch">edit</a>]</span> <span class="mw-headline"> Size of the Kernel Patch </span></h3>
<p>Comparison of the different patches ...
</p>
<table class="wikitablenowrap">
<tr>
<th> patch
</th><th> hunks
</th><th> +
</th><th> -
</th></tr>
<tr>
<td> patch-2.4.24-vs1.00.diff
</td><td> 178
</td><td> 1112
</td><td> 135
</td></tr>
<tr>
<td> patch-2.4.24-vs1.20.diff
</td><td> 216
</td><td> 2035
</td><td> 178
</td></tr>
<tr>
<td> patch-2.4.24-vs1.26.diff
</td><td> 225
</td><td> 2118
</td><td> 180
</td></tr>
<tr>
<td> patch-2.4.25-vs1.27.diff
</td><td> 252
</td><td> 2166
</td><td> 201
</td></tr>
<tr>
<td> patch-2.4.26-vs1.28.diff
</td><td> 254
</td><td> 2183
</td><td> 202
</td></tr>
<tr>
<td> patch-2.6.6-vs1.9.0.diff
</td><td> 494
</td><td> 5699
</td><td> 303
</td></tr>
<tr>
<td> patch-2.6.6-vs1.9.1.diff
</td><td> 497
</td><td> 5878
</td><td> 307
</td></tr>
<tr>
<td> patch-2.6.7-vs1.9.2.diff
</td><td> 618
</td><td> 6836
</td><td> 348
</td></tr>
<tr>
<td> uml-patch-2.4.26-1.diff
</td><td> 449
</td><td> 36885
</td><td> 48
</td></tr></table>
<a name="Non_Intel_i386_Hardware" id="Non_Intel_i386_Hardware"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=52" title="Edit section: Non Intel i386 Hardware">edit</a>]</span> <span class="mw-headline"> Non Intel i386 Hardware </span></h2>
<p>Linux-VServer was designed to be mostly architecture agnostic, therefore only a small part, the syscall definition itself, is architecture specific. Nevertheless some architectures have private copies of basically architecture independent code for whatever reason, and therefore small modifications are often required.
</p><p>The following architectures are supported and some of them are even tested:
</p>
<ul><li> alpha
</li><li> ia32 / ia64 / xbox
</li><li> x86_64 (AMD64)
</li><li> mips / mips64
</li><li> hppa / hppa64
</li><li> ppc / ppc64
</li><li> sparc / sparc64
</li><li> s390
</li><li> uml
</li></ul>
<p>Adding a new architecture is relatively simple although extensive testing is required to make sure that every feature is working as expected (and of course, the hardware&nbsp;;).
</p>
<a name="Linux_Kernel_Intro" id="Linux_Kernel_Intro"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=53" title="Edit section: Linux Kernel Intro">edit</a>]</span> <span class="mw-headline"> Linux Kernel Intro </span></h2>
<p>While almost all of the described features reside in the Linux Kernel, nifty Userspace Tools are required to activate and control the new functionality.
</p><p>Those Userspace Tools in general communicate with the Linux Kernel via System Calls (or Syscall for short).
This chapter will give a short overview how Linux Kernel and User Space is organized and how Syscalls, a simple method of communication between processes and kernel, work.
</p>
<a name="Kernel_and_User_Space" id="Kernel_and_User_Space"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=54" title="Edit section: Kernel and User Space">edit</a>]</span> <span class="mw-headline"> Kernel and User Space </span></h3>
<p>In Linux and similar Operating Systems, User and Kernel Space is separated, and address space is divided into two parts. Kernel space is where the kernel code resides, and user space is where the user programs live. Of course, a given user program can't write to kernel memory or to another program's memory area.
</p><p>Unfortunately, this is also the case for kernel code. Kernel code can't write to user space either. What does this mean? Well, when a given hardware driver wants to write data bytes to a program in user memory, it can't do it directly, but rather it must use specific kernel functions instead. Also, when parameters are passed by address to a kernel function, the kernel function can not read the parameters directly. It must use other kernel functions to read each byte of the parameters.
</p><p>Of course, there are some helpers which do the transfer to and from user space.
</p>
<pre>
copy_to_user(void *to, const void *from, long n);
copy_from_user(void *to, const void *from, long n);
</pre>
<p>get_user() and put_user() Get or put the given byte, word, or long from or to user memory. This is a macro, and it relies on the type of the argument to determine the number of bytes to transfer.
</p>
<a name="Linux_Syscalls" id="Linux_Syscalls"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=55" title="Edit section: Linux Syscalls">edit</a>]</span> <span class="mw-headline"> Linux Syscalls </span></h3>
<p>Most libc calls rely on system calls, which are the simplest kernel functions a user program can call.
</p><p>These system calls are implemented in the kernel itself or in loadable kernel modules, which are little chunks of dynamically link-able kernel code.
</p><p>Linux system calls are implemented through a multiplexor called with a given maskable interrupt. In Linux, this interrupt is int 0x80. When the 'int 0x80' instruction is executed, control is given to the kernel (or, more accurately, to the _system_call() function), and the actual demultiplexing process occurs.
</p><p>How does _system_call() work&nbsp;?
</p><p>First, all registers are saved and the content of the&nbsp;%eax register is checked against the global system calls table, which enumerates all system calls and their addresses.
</p><p>This table can be accessed with the extern void *sys_call_table[] variable. A given number and memory address in this table corresponds to each system call.
</p><p>System call numbers can be found in /usr/include/sys/syscall.h.
</p><p>They are of the form SYS_systemcallname. If the system call is not implemented, the corresponding cell in the sys_call_table is 0, and an error is returned.
</p><p>Otherwise, the system call actually exists and the corresponding entry in the table is the memory address of the system call code.
</p>
<a name="Kernel_Side_Implementation" id="Kernel_Side_Implementation"></a><h2><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=56" title="Edit section: Kernel Side Implementation">edit</a>]</span> <span class="mw-headline"> Kernel Side Implementation </span></h2>
<p>While this chapter is mainly of interest to kernel developers it might be fun to take a small peek behind the curtain to get a glimpse how everything really works.
</p>
<a name="The_Syscall_Command_Switch" id="The_Syscall_Command_Switch"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=57" title="Edit section: The Syscall Command Switch">edit</a>]</span> <span class="mw-headline"> The Syscall Command Switch </span></h3>
<p>For a long time Linux-VServer used a few different Syscalls to accomplish different aspects of the work, but very soon the number of required commands grew large, and the Syscalls started to have magic values, selecting the desired behavior.
</p><p>Not too long ago, a single syscall was reserved for Linux-VServer, and while the opinion on that might differ from developer to developer, it was generally considered a good decision not to have more than one syscall.
</p><p>The advantage of different Syscalls would be simpler handling of the Syscalls on different architectures; however, this hasn't been a problem so far, as the data passed to and from the kernel has strong typed fields conforming to the C99 types.
</p><p>Regardless, the availability of one system call required the creation of a multiplexor, which decides, based on some selector, what specific command is to be executed, and then passes on the remaining arguments to that command, which does the actual work.
</p>
<pre>
extern asmlinkage long
sys_vserver(uint32_t cmd, uint32_t id, void __user *data)
</pre>
<p>The Linux-VServer syscall is passed three arguments regardless of what actual command is specified: a command (cmd), a number (id), and a user-space data-structure of yet unknown size.
</p><p>To allow for some structure for debugging purposes and some kind of command versioning, the cmd is split into three parts: the lower 12 bit contain a version number, then 4 bits are reserved, the upper 16 bits are divided into 8 bit command and 6 bit category, again reserving 2 bits for the future.
</p><p>There are 64 Categories with up to 256 commands in each category, allowing for 4096 revisions of each command, which is far more than will ever be required.
</p><p>Here is an overview of the categories already defined, and their numerical value:
</p>
<pre>
 Syscall Matrix V2.6

        |VERSION|CREATE |MODIFY |MIGRATE|CONTROL|EXPERIM| |SPECIAL|SPECIAL|
        |STATS  |DESTROY|ALTER  |CHANGE |LIMIT  |TEST   | |       |       |
        |INFO   |SETUP  |       |MOVE   |       |       | |       |       |
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 SYSTEM |VERSION|VSETUP |VHOST  |       |       |       | |DEVICES|       |
 HOST   |     00|     01|     02|     03|     04|     05| |     06|     07|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 CPU    |       |VPROC  |PROCALT|PROCMIG|PROCTRL|       | |SCHED. |       |
 PROCESS|     08|     09|     10|     11|     12|     13| |     14|     15|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 MEMORY |       |       |       |       |       |       | |SWAP   |       |
        |     16|     17|     18|     19|     20|     21| |     22|     23|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 NETWORK|       |VNET   |NETALT |NETMIG |NETCTL |       | |SERIAL |       |
        |     24|     25|     26|     27|     28|     29| |     30|     31|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 DISK   |       |       |       |       |       |       | |INODE  |       |
 VFS    |     32|     33|     34|     35|     36|     37| |     38|     39|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 OTHER  |       |       |       |       |       |       | |VINFO  |       |
        |     40|     41|     42|     43|     44|     45| |     46|     47|
 =======+=======+=======+=======+=======+=======+=======+ +=======+=======+
 SPECIAL|       |       |       |       |FLAGS  |       | |       |       |
        |     48|     49|     50|     51|     52|     53| |     54|     55|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
 SPECIAL|       |       |       |       |RLIMIT |SYSCALL| |       |COMPAT |
        |     56|     57|     58|     59|     60|TEST 61| |     62|     63|
 -------+-------+-------+-------+-------+-------+-------+ +-------+-------+
</pre>
<p>The definition of those Commands is simplified by some macros, so for example the commands to get and set the Context Flags are defined like this:
</p>
<pre>
#define VCMD_get_cflags         VC_CMD(FLAGS, 1, 0)
#define VCMD_set_cflags         VC_CMD(FLAGS, 2, 0)

extern int vc_get_cflags(uint32_t, void __user *);
extern int vc_set_cflags(uint32_t, void __user *);
</pre>
<p>Note that the command itself is not passed to the actual command implementation, only the id and the pointer to user-space data.
</p>
<a name="Utilized_Data_Structures" id="Utilized_Data_Structures"></a><h3><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=58" title="Edit section: Utilized Data Structures">edit</a>]</span> <span class="mw-headline"> Utilized Data Structures </span></h3>
<p>There are many different data structures used by different parts of the implementation; while only a few examples are given here, all utilized structures can be found in the source.
</p>
<a name="The_Context_Data_Structure" id="The_Context_Data_Structure"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=59" title="Edit section: The Context Data Structure">edit</a>]</span> <span class="mw-headline"> The Context Data Structure </span></h4>
<p>The Context Data Structure consists of a few fields required to manage the contexts, and handle context destruction, as well as future hierarchical contexts.
</p><p>Logically separated sections of that structure, like for the scheduler or the context limits are defined in separate structures, and incorporated into the main one.
</p>
<pre>
struct vx_info {
        struct list_head vx_list;         /* linked list of contexts */
        xid_t vx_id;                      /* context id */
        atomic_t vx_refcount;             /* refcount */
        struct vx_info *vx_parent;        /* parent context */

        struct namespace *vx_namespace;   /* private namespace */
        struct fs_struct *vx_fs;          /* private namespace fs */
        uint64_t vx_flags;                /* context flags */
        uint64_t vx_bcaps;                /* bounding caps (system) */
        uint64_t vx_ccaps;                /* context caps (vserver) */

        pid_t vx_initpid;                 /* PID of fake init process */

        struct _vx_limit limit;           /* vserver limits */
        struct _vx_sched sched;           /* vserver scheduler */
        struct _vx_cvirt cvirt;           /* virtual/bias stuff */
        struct _vx_cacct cacct;           /* context accounting */

        char vx_name[65];                 /* vserver name */
};
</pre>
<p>Here as example the Scheduler Substructure:
</p>
<pre>
struct _vx_sched {
        spinlock_t tokens_lock; /* lock for this structure */

        int fill_rate;          /* Fill rate:      add X tokens ... */
        int interval;           /* Divisor:      ... each Y jiffies */
        atomic_t tokens;        /*         current number of tokens */
        int tokens_min;         /* Limit:        minimum for unhold */
        int tokens_max;         /* Limit:     no more than N tokens */
        uint32_t jiffies;       /* bias:     integral multiple of Y */

        uint64_t ticks;         /* token tick events */
        cpumask_t cpus_allowed; /* cpu mask for context */
};
</pre>
<p>The main idea behind this separation is that each substructure belongs to a logically distinct part of the implementation which provides an init and cleanup function for this structure, thus simplifying maintainability and readability of those structures.
</p>
<a name="The_Scheduler_Command_Data" id="The_Scheduler_Command_Data"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=60" title="Edit section: The Scheduler Command Data">edit</a>]</span> <span class="mw-headline"> The Scheduler Command Data </span></h4>
<p>As an example for the data structure used to control a specific part of the context from user-space, here is a scheduler command and the utilized data structure to set the properties:
</p>
<pre>
#define VCMD_set_sched          VC_CMD(SCHED, 1, 2)

struct  vcmd_set_sched_v2 {
        int32_t fill_rate;      /* Fill rate:      add X tokens ... */
        int32_t interval;       /* Divisor:      ... each Y jiffies */
        int32_t tokens;         /*         current number of tokens */
        int32_t tokens_min;     /* Limit:        minimum for unhold */
        int32_t tokens_max;     /* Limit:     no more than N tokens */
        uint64_t cpu_mask;      /* Mask:               allowed cpus */
};
</pre>
<a name="Example_Accounting:_Sockets" id="Example_Accounting:_Sockets"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=61" title="Edit section: Example Accounting: Sockets">edit</a>]</span> <span class="mw-headline"> Example Accounting: Sockets </span></h4>
<p>Basically all the accounting and limit stuff are defined as macros or inline functions capable of handling the different resources, hiding the underlying implementation wherever possible.
</p>
<pre>
#define vx_acc_sock(v,f,p,s) \
        __vx_acc_sock((v), (f), (p), (s), __FILE__, __LINE__)

static inline void __vx_acc_sock(struct vx_info *vxi,
        int family, int pos, int size, char *file, int line)
{
        if (vxi) {
                int type = vx_sock_type(family);

                atomic_inc(&amp;vxi-&gt;cacct.sock[type][pos].count);
                atomic_add(size, &amp;vxi-&gt;cacct.sock[type][pos].total);
        }
}

#define vx_sock_recv(sk,s) \
        vx_acc_sock((sk)-&gt;sk_vx_info, (sk)-&gt;sk_family, 0, (s))
#define vx_sock_send(sk,s) \
        vx_acc_sock((sk)-&gt;sk_vx_info, (sk)-&gt;sk_family, 1, (s))
#define vx_sock_fail(sk,s) \
        vx_acc_sock((sk)-&gt;sk_vx_info, (sk)-&gt;sk_family, 2, (s))
</pre>
<p>And this general definition is then used where appropriate, for example in the __sock_sendmsg() function like this:
</p>
<pre>
len = sock-&gt;ops-&gt;sendmsg(iocb, sock, msg, size);
if (sock-&gt;sk) {
        if (len == size)
                vx_sock_send(sock-&gt;sk, size);
        else
                vx_sock_fail(sock-&gt;sk, size);
}
</pre>
<a name="Example_Limits:_Virtual_Memory" id="Example_Limits:_Virtual_Memory"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=62" title="Edit section: Example Limits: Virtual Memory">edit</a>]</span> <span class="mw-headline"> Example Limits: Virtual Memory </span></h4>
<pre>
#define vx_pages_avail(m, p, r) \
        __vx_pages_avail((m)-&gt;mm_vx_info, (r), (p), __FILE__, __LINE__)

static inline int __vx_pages_avail(struct vx_info *vxi,
                int res, int pages, char *file, int line)
{
        if (!vxi)
                return 1;
        if (vxi-&gt;limit.rlim[res] == RLIM_INFINITY)
                return 1;
        if (atomic_read(&amp;vxi-&gt;limit.res[res]) +
                pages &lt; vxi-&gt;limit.rlim[res])
                return 1;
        return 0;
}

#define vx_vmpages_avail(m,p)  vx_pages_avail(m, p, RLIMIT_AS)
#define vx_vmlocked_avail(m,p) vx_pages_avail(m, p, RLIMIT_MEMLOCK)
#define vx_rsspages_avail(m,p) vx_pages_avail(m, p, RLIMIT_RSS)
</pre>
<p>And again the test against those limits at certain places, for example here in copy_process()
</p>
<pre>
/* check vserver memory */
if (p-&gt;mm &amp;&amp;&nbsp;!(clone_flags &amp; CLONE_VM)) {
        if (vx_vmpages_avail(p-&gt;mm, p-&gt;mm-&gt;total_vm))
                vx_pages_add(p-&gt;mm-&gt;mm_vx_info,
                        RLIMIT_AS, p-&gt;mm-&gt;total_vm);
        else
                goto bad_fork_free;
}
</pre>
<a name="Example_Virtualization:_Uptime" id="Example_Virtualization:_Uptime"></a><h4><span class="editsection">[<a href="/index.php?title=Paper&amp;action=edit&amp;section=63" title="Edit section: Example Virtualization: Uptime">edit</a>]</span> <span class="mw-headline"> Example Virtualization: Uptime </span></h4>
<pre>
void vx_vsi_uptime(struct timespec *uptime)
{
        struct vx_info *vxi = current-&gt;vx_info;

        set_normalized_timespec(uptime,
                uptime-&gt;tv_sec - vxi-&gt;cvirt.bias_tp.tv_sec,
                uptime-&gt;tv_nsec - vxi-&gt;cvirt.bias_tp.tv_nsec);
        return;
}

if (vx_flags(VXF_VIRT_UPTIME, 0))
        vx_vsi_uptime(&amp;uptime, &amp;idle);
</pre>
<p>== Future Direction
</p>
<!-- 
NewPP limit report
Preprocessor node count: 106/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key wiki:pcache:idhash:1414-0!1!0!!en!2 and timestamp 20110607023448 -->
<div class="printfooter">
Retrieved from "<a href="http://linux-vserver.org/Paper">http://linux-vserver.org/Paper</a>"</div>
						<!-- end content -->
						<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<ul>
				 <li id="ca-nstab-main" class="selected"><a href="/Paper">Page</a></li>
				 <li id="ca-talk" class="new"><a href="/index.php?title=Talk:Paper&amp;action=edit&amp;redlink=1">Discussion</a></li>
				 <li id="ca-edit"><a href="/index.php?title=Paper&amp;action=edit">Edit</a></li>
				 <li id="ca-history"><a href="/index.php?title=Paper&amp;action=history">History</a></li>
		</ul>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-login"><a href="/index.php?title=Special:UserLogin&amp;returnto=Paper">Log in / create account</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(/skins/common/images/wiki.png);" href="/Welcome_to_Linux-VServer.org" title="Welcome to Linux-VServer.org"></a>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="/Special:Search" id="searchform"><div>
				<input id="searchInput" name="search" type="text" accesskey="f" value="" />
				<input type='image' name="go" class="searchButton" id="searchGoButton"	value="Go"
				 src="/skins/vwiki/search.gif" title="Title Search" />
				<input type='image' name="fulltext" class="searchButton" value="Search"
				 src="/skins/vwiki/fulltextsearch.gif" title="Fulltext Search" />
			</div></form>
		</div>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-About'>
		<h5>About</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Overview"><a href="/Overview">Overview</a></li>
				<li id="n-Paper"><a href="/Paper">Paper</a></li>
				<li id="n-News"><a href="/News">News</a></li>
				<li id="n-Developers"><a href="/Developers">Developers</a></li>
				<li id="n-Donations"><a href="/Donations">Donations</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-Getting Started'>
		<h5>Getting Started</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Downloads"><a href="/Downloads">Downloads</a></li>
				<li id="n-FAQs"><a href="/Frequently_Asked_Questions">FAQs</a></li>
				<li id="n-Documentation"><a href="/Documentation">Documentation</a></li>
				<li id="n-Support"><a href="/Communicate">Support</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-Participate'>
		<h5>Participate</h5>
		<div class='pBody'>
			<ul>
				<li id="n-How-to-participate"><a href="/How_to_participate">How to participate</a></li>
				<li id="n-Report-a-Bug"><a href="/Report_a_Bug">Report a Bug</a></li>
				<li id="n-Communicate"><a href="/Communicate">Communicate</a></li>
				<li id="n-Teams/Projects"><a href="/Teams_and_Projects">Teams/Projects</a></li>
				<li id="n-Hall-of-Fame"><a href="/Hall_of_Fame">Hall of Fame</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-Resources'>
		<h5>Resources</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Archives"><a href="/Archives">Archives</a></li>
				<li id="n-Recent-Wiki-Changes"><a href="/Special:RecentChanges">Recent Wiki Changes</a></li>
				<li id="n-Pastebin"><a href="http://paste.linux-vserver.org">Pastebin</a></li>
				<li id="n-Related-Projects"><a href="/Related_Projects">Related Projects</a></li>
				<li id="n-VServer-Hosting"><a href="/VServer_Hosting">VServer Hosting</a></li>
				<li id="n-Happy-VServer-Users"><a href="/VServer_Users">Happy VServer Users</a></li>
			</ul>
		</div>
	</div>
		<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="/Special:WhatLinksHere/Paper">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="/Special:RecentChangesLinked/Paper">Related changes</a></li>
<li id="t-specialpages"><a href="/Special:SpecialPages">Special pages</a></li>
				<li id="t-print"><a href="/index.php?title=Paper&amp;printable=yes">Printable version</a></li>				<li id="t-permalink"><a href="/index.php?title=Paper&amp;oldid=4652">Permanent link</a></li>			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>
				<div id="f-copyrightico"><a href="http://www.gnu.org/copyleft/fdl.html"><img src="/skins/common/images/gnu-fdl.png" alt='GNU Free Documentation License 1.2' /></a></div>
			<ul id="f-list">
				<li id="lastmod"> This page was last modified on 12 May 2011, at 12:01.</li>
				<li id="copyright">Content is available under <a href="http://www.gnu.org/copyleft/fdl.html" class="external " title="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.2</a>.</li>
			</ul>&nbsp;
		</div>
	<script type="text/javascript"> if (window.runOnloadHook) runOnloadHook();</script>
</div>
<!-- Served in 0.022 secs. -->
</body></html>
